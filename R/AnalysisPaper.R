# ******************************************************************************
# Intraday Overreaction - AnalysisPaper.R                                      *
# ******************************************************************************
# This file contains all analyses required for the final paper                 *
# ******************************************************************************

# 1. DATALOAD ------------------------------------------------------------------

# 1.1) Load symbol and variable info -------------------------------------------
# get symbol info
symbol.info <- 
  read.csv ("D:/Doktorarbeit/40 Data/Stocks/Taipan/symbol_info2.csv", 
            header=TRUE, stringsAsFactors=FALSE, comment.char="", 
            col.names=c("Symbol", "shares_out", "Name", 
                        "Sector", "Industry", "Country", "shares_fl",
                        "NMS_Date", "SSB_Date_1" ,"SSB_Date_2"), 
            colClasses=c("character", "numeric", rep("character", 4), "numeric",
                         rep("character",3)))
rownames(symbol.info) <- symbol.info$Symbol
class(symbol.info[,8:10]) <- "Date"

# remove excess symbol
symbol.info <- symbol.info[-which(symbol.info$Symbol == "RDS-A.N"),]

# 1.2) load data bases ---------------------------------------------------------
# create temporary environment for partial DB-load
load.env <- new.env()

# 1.2a) load and merge InstanceDB, Sum series, and Stockday Panel data frames
#       [Generated by BuildInstanceDB_HL0.R]
db.files <- list.files (path = data.path.out, pattern = '*part[1-9].idb')
for (db in seq_along(db.files)) {
  # load part into load-environment
  rm (list=ls(load.env), envir=load.env)
  load (file=paste(data.path.out, db.files[db], sep=""), envir=load.env)

  # copy part 1 into general workspace for merging
  if (db == 1) {
    for (i in seq_along(ls(load.env))) {
      assign(ls(load.env)[i], get(ls(load.env)[i], envir=load.env)) 
    }    
  } else {
    # perform merge procedures for other parts
    # m.1: InstanceDBs
    events.master.up.df <- rbind (events.master.up.df, 
                                  load.env$events.master.up.df)
    events.master.dn.df <- rbind (events.master.dn.df, 
                                  load.env$events.master.dn.df)
    # m.2: sum objects
    active.stocks.sum.x <- active.stocks.sum.x + 
      load.env$active.stocks.sum.x[index(active.stocks.sum.x)]
    hft.flags.sum.x     <- hft.flags.sum.x + 
      load.env$hft.flags.sum.x[index(hft.flags.sum.x)]
    hft.mins.sum.x      <- hft.mins.sum.x + 
      load.env$hft.mins.sum.x[index(hft.mins.sum.x)]
    # m.3: stock-day panels (containing descriptive daily panel variables)
    for (i in seq_along(ls(load.env, pattern="stocks.*.df"))) {
      cur.name <- ls (load.env, pattern="stocks.*.df")[i]
      assign(cur.name, MergeStockdayPanels(get(cur.name), 
                                           get(cur.name, envir=load.env)))
    }
  }
}
# sort InstanceDB by timestamp and symbol
events.master.up.df <- 
  events.master.up.df[with(events.master.up.df, order(timestamp)), ]
events.master.dn.df <- 
  events.master.dn.df[with(events.master.dn.df, order(timestamp)), ]
# restore InstanceDB timestamp-symbol rownames
row.names (events.master.up.df) <- paste (events.master.up.df$timestamp, 
                                          events.master.up.df$symbol, sep=" ")
row.names (events.master.dn.df) <- paste (events.master.dn.df$timestamp, 
                                          events.master.dn.df$symbol, sep=" ")
# remove events data base since not needed in the paper
# rm(events.master.up.df)
# rm(events.master.dn.df)

# 1.2b) load and merge HiLo-based score PanelDBs
#       [Generated by BuildScorePanel0B.R]
db.files <- list.files (path = data.path.out, pattern = '*part[1-9]bb.pdb')
for (db in seq_along(db.files)) {
  # load part into load-environment
  rm (list=ls(load.env), envir=load.env)
  load (file=paste(data.path.out, db.files[db], sep=""), envir=load.env)
  # copy part 1 into general workspace for merging
  if (db == 1) {
    for (i in seq_along(ls(load.env))) {
      assign(ls(load.env)[i], get(ls(load.env)[i], envir=load.env)) 
    }    
  } else {
    for (i in seq_along(ls(load.env))) {
      cur.name <- ls (load.env)[i]
      assign(cur.name, MergeStockdayPanels(get(cur.name), 
                                           get(cur.name, envir=load.env)))
    }
  }
}

# 1.2c) load and merge distribution PanelDBs
#       [Generated by BuildScorePanel0C.R]
db.files <- list.files (path = data.path.out, pattern = '*Dist.part[1-9].pdb')
for (db in seq_along(db.files)) {
  # load part into load-environment
  rm (list=ls(load.env), envir=load.env)
  load (file=paste(data.path.out, db.files[db], sep=""), envir=load.env)
  # copy part 1 into general workspace for merging
  if (db == 1) {
    for (i in seq_along(ls(load.env))) {
      assign(ls(load.env)[i], get(ls(load.env)[i], envir=load.env)) 
    }    
  } else {
    for (i in seq_along(ls(load.env))) {
      cur.name <- ls (load.env)[i]
      assign(cur.name, MergeStockdayPanels(get(cur.name), 
                                           get(cur.name, envir=load.env)))
    }
  }
}

# 1.2d) load and merge DSB MOM and RVOL PanelDBs
#       [Generated by BuildScorePanel0D.R]
db.files <- list.files (path = data.path.out, pattern = '*DSBM_RVOL*')
for (db in seq_along(db.files)) {
  # load part into load-environment
  rm (list=ls(load.env), envir=load.env)
  load (file=paste(data.path.out, db.files[db], sep=""), envir=load.env)
  # copy part 1 into general workspace for merging
  if (db == 1) {
    for (i in seq_along(ls(load.env))) {
      assign(ls(load.env)[i], get(ls(load.env)[i], envir=load.env)) 
    }    
  } else {
    for (i in seq_along(ls(load.env))) {
      cur.name <- ls (load.env)[i]
      assign(cur.name, MergeStockdayPanels(get(cur.name), 
                                           get(cur.name, envir=load.env)))
    }
  }
}

# 1.2e) load and merge Parkinson Volatility PanelDBs
#       [Generated by BuildScorePanel0E.R]
db.files <- list.files (path = data.path.out, pattern = '*ParkVol*')
for (db in seq_along(db.files)) {
  # load part into load-environment
  rm (list=ls(load.env), envir=load.env)
  load (file=paste(data.path.out, db.files[db], sep=""), envir=load.env)
  # copy part 1 into general workspace for merging
  if (db == 1) {
    for (i in seq_along(ls(load.env))) {
      assign(ls(load.env)[i], get(ls(load.env)[i], envir=load.env)) 
    }    
  } else {
    for (i in seq_along(ls(load.env))) {
      cur.name <- ls (load.env)[i]
      assign(cur.name, MergeStockdayPanels(get(cur.name), 
                                           get(cur.name, envir=load.env)))
    }
  }
}

# 1.3) fix symbol-name issues in all stocks.xxx Stockday Panels ----------------
# Attention: regular expression ^requires "stocks" at start of string
for (i in seq_along(ls(pattern="^stocks.*"))) {
  cur.name <- ls (pattern="^stocks.*")[i]
  test.df <- get (cur.name)
  names(test.df)[names(test.df) == "BF.B.N"] <- "BF-B.N"
  names(test.df)[names(test.df) == "BRK.B.N"] <- "BRK-B.N"
  names(test.df)[names(test.df) == "FCE.A.N"] <- "FCE-A.N"
  names(test.df)[names(test.df) == "HUB.B.N"] <- "HUB-B.N"
  names(test.df)[names(test.df) == "RDS.A.N"] <- "RDS-A.N"
  names(test.df)[names(test.df) == "RDS.B.N"] <- "RDS-B.N"
  # sort columns alphabetically by symbol
  test.df <- test.df[, order(colnames(test.df))]
  assign (cur.name, test.df)
}
rm(test.df)

# check naming consistency
bm.names <- names (stocks.HFTflags.df)
for (i in seq_along(ls(pattern="^stocks.*"))) {
  cur.name <- ls (pattern="^stocks.*")[i]
  test.df <- get (cur.name)
  print(paste(cur.name, names(test.df)[1], names(test.df)[length(names(test.df))]))
  stopifnot(all.equal(names(test.df), bm.names))
}
rm(test.df)
rm(bm.names)

# 1.4) construct exogenous HFT factor variables --------------------------------
# construct time series for each symbol/date in other panels
date.idx <- as.Date(rownames(stocks.HFTflags.df))
stock.idx <- names(stocks.HFTflags.df)
stocks.NMS.df <- as.data.frame (t(sapply(1:length(date.idx), function(x) 
  date.idx[x] >= as.Date(as.chron(symbol.info[stock.idx,]$NMS_Date)))))
stocks.SSB.df <- as.data.frame (t(sapply(1:length(date.idx), function(x) 
  date.idx[x] >= as.Date(as.chron(symbol.info[stock.idx,]$SSB_Date_1)) &
  date.idx[x] <= as.Date(as.chron(symbol.info[stock.idx,]$SSB_Date_2)) )))
stocks.SSB.df[is.na(stocks.SSB.df)] <- FALSE
names(stocks.NMS.df) <- stock.idx
rownames(stocks.NMS.df) <- date.idx
names(stocks.SSB.df) <- stock.idx
rownames(stocks.SSB.df) <- date.idx
rm(stock.idx)
rm(date.idx)

# 1.5) construct MA60-versions of daily stock characteristics for rankings -----
# stocks.liqsMA.df <- MovingAvgDf (LagDf(stocks.liqs.df))
stocks.tovsMA.df <- MovingAvgDf (LagDf(stocks.tovs.df))
# stocks.hlrsMA.df <- MovingAvgDf (LagDf(stocks.hlrs.df))
# rm(stocks.liqsMA.df)
# rm(stocks.tovsMA.df)
# rm(stocks.hlrsMA.df)

# 1.z) Clean-up
rm(load.env)
rm(db.files)
rm(db)
rm(cur.name)

# 2. DESCRIPTIVE STATISTICS ----------------------------------------------------

# 2.1) HFT Frequency by Severity Plot ------------------------------------------
# getting dataframe indices by year

stocks.HFTflagrate.df <- stocks.HFTflags.df / (daybars * 60)
stocks.HFTflagrate.df <- na.fill(stocks.HFTflagrate.df, 0)

stocks.HFTflagrate.2006 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2006),])
stocks.HFTflagrate.2007 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2007),])
stocks.HFTflagrate.2008 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2008),])
stocks.HFTflagrate.2009 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2009),])
stocks.HFTflagrate.2010 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2010),])
stocks.HFTflagrate.2011 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2011),])
stocks.HFTflagrate.2012 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2012),])
stocks.HFTflagrate.2013 <- colMeans(stocks.HFTflagrate.df[
  which(years(as.chron(rownames(stocks.HFTflags.df)))==2013),])

breaks.freq <- c(0, 0.0001, 0.0002, 0.0005, 0.001, 0.002, 0.005, 
                 0.01, 0.02, 0.05, 0.1, 0.2)

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2006, 
                                breaks=breaks.freq, plot=F)
plot(y=100 * stocks.HFTflagrate.hist$counts / 
       mean(active.stocks.sum.x[which(years(
         as.chron(index(active.stocks.sum.x)))==2006)]), 
     x=100 * stocks.HFTflagrate.hist$breaks[-(1)], log="x", type="l", lwd=2,
     xlab="% Flagrate/Second", ylab="% of Stocks", ylim=c(0, 80),
     col=rainbow(8, start=rainbow.start, end=rainbow.end )[1])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2007, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2007)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[2])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2008, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2008)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[3])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2009, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2009)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[4])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2010, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2010)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[5])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2011, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2011)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[6])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2012, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2012)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[7])

stocks.HFTflagrate.hist <- hist(x=stocks.HFTflagrate.2013, 
                                breaks=breaks.freq, plot=FALSE)
lines(y=100 * stocks.HFTflagrate.hist$counts / 
        mean(active.stocks.sum.x[which(years(
          as.chron(index(active.stocks.sum.x)))==2013)]), 
      x=100 * stocks.HFTflagrate.hist$breaks[-(1)],
      lwd=2, col=rainbow(8, start=rainbow.start, end=rainbow.end )[8])

# 2.2) HFT activity minute- and flag-rates over time ---------------------------
plot (100 * (hft.mins.sum.x/active.stocks.sum.x)['2006-01-03/2013-08-28'] / 
        daybars, ylab="% of total stock minutes", 
      main="% of HFT affected stocks, by minute")
lines(xts(order.by=index(hft.mins.sum.x), x=MovingAvg (
  100*(hft.mins.sum.x/active.stocks.sum.x)/daybars, period.oneyear)), lwd=2,
      col="blue")
legend("topleft", "(x,y)", c("HFT activity", "1-year rolling avg."), lty=rep(1,2),
       lwd=rep(2,2),col=c("black","blue"))

plot (100 * (hft.flags.sum.x/active.stocks.sum.x)['2006-01-03/2013-08-28'] /
        (daybars * 60), ylab="% of total stock seconds", 
      main="% of HFT affected stocks, by second")
lines(xts(order.by=index(hft.flags.sum.x), x=MovingAvg (
  100*(hft.flags.sum.x/active.stocks.sum.x)/(daybars*60), period.oneyear)), 
      lwd=2, col="blue")
legend("topleft", "(x,y)", c("HFT activity", "1-year rolling avg."), lty=rep(1,2),
       lwd=rep(2,2),col=c("black","blue"))

plot(xts(100*apply(stocks.HFTpquotes.df/stocks.prices.df, 1, mean, na.rm=T, trim=.001), 
         as.Date(rownames(stocks.HFTpquotes.df)))['2011-10-03/2012-01-31'])

plot(xts(100*apply(stocks.HFTpquotes.df, 1, mean, na.rm=T, trim=.001), 
         as.Date(rownames(stocks.HFTpquotes.df)))['2007-01-01/2007-12-31'])

plot(xts(100*apply(stocks.HFTpquotes.df, 1, median, na.rm=T), 
         as.Date(rownames(stocks.HFTpquotes.df)))['2007-01-01/2007-12-31'])

plot(xts(100*apply(stocks.HFTpquotes.df * stocks.liqs.df / stocks.prices.df, 1, quantile, probs=.5, na.rm=T), 
         as.Date(rownames(stocks.HFTpquotes.df)))['2007-01-01/2007-12-31'])
# --> redundant with 2.3a0)

# 2.3) Data Summary Statistics Overview ----------------------------------------

# "full sample": 2006-01-03 - 2013-08-28
range.idx <- 252:2161
head(rownames(stocks.HFTflags.df[range.idx,]))
tail(rownames(stocks.HFTflags.df[range.idx,]))

# remove 2008-11-20 due to missing HFT data
range.idx <- range.idx[-which(rownames(stocks.HFTflags.df[range.idx,])==
                                "2008-11-20")]
stocks.remove <- c("AMRN.Q", "EFUT.Q", "FFHL.Q", "ROSG.Q", "UNXL.Q", "VHC.A")
stocks.sel <- !(names(stocks.HFTflags.df) %in% stocks.remove)

# get date axis tick-values for plotting
endpoints((as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), "years") + 1
axis.dates <- (endpoints((as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
                         "years") + 1)[1:8]
axis.dates <- (as.Date(rownames(stocks.HFTflags.df[range.idx, ])))[axis.dates]

# define vol/liq-adjusted HFT measures
stocks.HFTflagsV.df <- stocks.HFTflags.df/((stocks.liqs.df/stocks.prices.df)/1000000)
stocks.HFTflagsL.df <- stocks.HFTflags.df/((stocks.liqs.df)/100000000)

# 2.3a0) HFT MINs per stock-minutes
plot(y=  100*hft.mins.sum.x/ 
       (active.stocks.sum.x[range.idx] * daybars), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="% of stock-minutes with HFT activity", type="l", lwd=1,
     ylab="% stock-minutes", xlab="Date", xaxt="n", col="grey40")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(100*hft.mins.sum.x/(active.stocks.sum.x[range.idx] * daybars),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=3, col="black", lty=1)
legend("topleft", bty="n", legend=c("% stock-minutes", "1Y-cent.mov.avg"),
       lty=c(1,1), lwd=c(1,3), col=c("grey40", "black"))

# 2.3a0) HFT flags per stock-second
plot(y=  hft.flags.sum.x / (active.stocks.sum.x[range.idx] * daybars * 60), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="% of stock-seconds with #HFT flags", type="l", lwd=1,
     ylab="% stock-seconds", xlab="Date", xaxt="n")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(hft.flags.sum.x/ 
                     (active.stocks.sum.x[range.idx] * daybars * 60),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=3, col="black", lty=1)
legend("topleft", legend=c("% stock-minutes", "1Y-cent.mov.avg."), cex=.8,
       lty=c(1,1), lwd=c(1,3), col=c("black", "black"))

# 2.3a1) HFT flags per stock
plot(y=apply(((stocks.HFTflags.df)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily #HFT flags cross-sectional aggregates", type="l", lwd=1,
     ylab="#flags", xlab="Date", ylim=c(0,1000), xaxt="n")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=apply(((stocks.HFTflags.df)/1)[range.idx, stocks.sel], 1, 
              function(x) quantile(x, na.rm=T, probs=.5)), 
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), col="grey50")
lines(y=MovingAvg2(apply(((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply(((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.5)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "median", 
                           "1Y-mean(median)"), cex=.8,
       lty=c(1,1,1,3), lwd=c(1,2,1,2), col=c("black", "black", "grey40", "black"))

# 2.3a11) HFT flags per Stock with Size Tercile Averages
rank.vec <- rank((apply((stocks.sizes.df[range.idx, stocks.sel]), 2, mean, na.rm=T)))
rank.vec <- rank.vec/length(rank.vec)
rank.cut <- cut(rank.vec, breaks=c(0, 1/3, 2/3, 1), 
                labels=c("L", "M", "H"), include.lowest=T)
plot(y=apply((stocks.HFTflags.df[range.idx, stocks.sel]), 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily #HFT flags cross-sectional aggregates", type="l", lwd=1,
     ylab="#flags", xlab="Date", xaxt="n", col="grey60", yaxt="n", log="y",
     ylim=c(0.2,6000))
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
axis(2, at=c(1,5,20,100,500),
     labels=as.character(c(1,5,20,100,500)))
lines(y=MovingAvg2(apply((stocks.HFTflags.df[range.idx, stocks.sel])[rank.cut=="H"], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply((stocks.HFTflags.df[range.idx, stocks.sel])[rank.cut=="M"], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=2)
lines(y=MovingAvg2(apply((stocks.HFTflags.df[range.idx, stocks.sel])[rank.cut=="L"], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
lines(y=MovingAvg2(apply(((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=4, col="grey50", lty=3)
lines(y=MovingAvg2(apply(((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=4, col="grey50", lty=3)

legend("topleft", ncol=2, bty = "n", legend=c("Large: 1Y-CMA(mean)", 
       "Medium: 1Y-CMA(mean)", "Small: 1Y-CMA(mean)",
       "All: daily mean", "All: 1Y-CMA(5/95%)"), cex=.8,
       lty=c(1,2,3,1,3), lwd=c(2,2,2,1,4), 
       col=c("black", "black", "black", "grey60", "grey50"))
rm(rank.vec)
rm(rank.cut)


# 2.3a2) log. HFT flags per stock
plot(y=apply(log1p((stocks.HFTflags.df)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily log. #HFT flags", type="l", lwd=1, xaxt="n",
     ylab="#flags", xlab="Date", ylim=c(0, 8))
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflags.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "1Y-mean(5/95%ile)"), cex=.8,
       lty=c(1,1,3), lwd=c(1,2,2), col=c("black", "black", "black"))

# 2.3b1) HFT flags per 1M shares traded
plot(y=apply((stocks.HFTflagsV.df[range.idx, stocks.sel]), 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily #HFT flags per 1 million shares traded", type="l", lwd=1,
     ylab="#flags", xlab="Date", xaxt="n")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=apply((stocks.HFTflagsV.df[range.idx, stocks.sel]), 1, 
              function(x) quantile(x, na.rm=T, probs=.5)), 
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), col="grey50")
lines(y=MovingAvg2(apply((stocks.HFTflagsV.df[range.idx, stocks.sel]), 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply((stocks.HFTflagsV.df[range.idx, stocks.sel]), 1, 
                         function(x) quantile(x, na.rm=T, probs=.5)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "median", 
                           "1Y-mean(median)"), cex=.8,
       lty=c(1,1,1,3), lwd=c(1,2,1,2), col=c("black", "black", "grey40", "black"))

# 2.3b11) HFT flags per 1M shares traded with Size Tercile Averages
rank.vec <- rank((apply((stocks.sizes.df[range.idx, stocks.sel]), 2, mean, na.rm=T)))
rank.vec <- rank.vec/length(rank.vec)
rank.cut <- cut(rank.vec, breaks=c(0, 1/3, 2/3, 1), 
                labels=c("L", "M", "H"), include.lowest=T)
plot(y=apply((stocks.HFTflagsV.df[range.idx, stocks.sel]), 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily #HFT flags per 1 million shares traded", type="l", lwd=1,
     ylab="#flags/1M shares", xlab="Date", xaxt="n", col="grey50", yaxt="n", log="y",
     ylim=c(0.2,1000))
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
axis(2, at=c(1,5,20,100,500),
     labels=as.character(c(1,5,20,100,500)))
lines(y=MovingAvg2(apply((stocks.HFTflagsV.df[range.idx, stocks.sel])[rank.cut=="H"], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply((stocks.HFTflagsV.df[range.idx, stocks.sel])[rank.cut=="M"], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=2)
lines(y=MovingAvg2(apply((stocks.HFTflagsV.df[range.idx, stocks.sel])[rank.cut=="L"], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
lines(y=MovingAvg2(apply(((stocks.HFTflagsV.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=4, col="grey50", lty=3)
lines(y=MovingAvg2(apply(((stocks.HFTflagsV.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=4, col="grey50", lty=3)

legend("topleft", ncol=1, legend=c("All: daily mean", "All: 1Y-cent.MA(5/95%ile)", "Large: 1Y-cent.MA(mean)", 
                           "Medium: 1Y-cent.MA(mean)", "Small: 1Y-cent.MA(mean)"), cex=.7,
       lty=c(1,3,1,2,3), lwd=c(1,4,2,2,2), 
       col=c("grey50", "grey50", "black", "black", "black"))
rm(rank.vec)
rm(rank.cut)

# 2.3b2) log flags per 1M shares traded
plot(y=apply(log1p((stocks.HFTflagsV.df)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily log. #HFT flags per 1 million shares traded", type="l", lwd=1,
     ylab="#flags", xlab="Date", ylim=c(0, 6.5), xaxt="n")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflagsV.df))[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflagsV.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflagsV.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "1Y-mean(5/95%ile)"), cex=.8,
       lty=c(1,1,3), lwd=c(1,2,2), col=c("black", "black", "black"))

# 2.3c1) HFT flags per $100M traded
plot(y=apply((stocks.HFTflagsL.df[range.idx, stocks.sel]), 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily #HFT flags per 1 million shares traded", type="l", lwd=1,
     ylab="#flags", xlab="Date", xaxt="n")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=apply((stocks.HFTflagsL.df[range.idx, stocks.sel]), 1, 
              function(x) quantile(x, na.rm=T, probs=.5)), 
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), col="grey50")
lines(y=MovingAvg2(apply((stocks.HFTflagsL.df[range.idx, stocks.sel]), 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply((stocks.HFTflagsL.df[range.idx, stocks.sel]), 1, 
                         function(x) quantile(x, na.rm=T, probs=.5)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "median", 
                           "1Y-mean(median)"), cex=.8,
       lty=c(1,1,1,3), lwd=c(1,2,1,2), col=c("black", "black", "grey40", "black"))

# 2.3c2) log flags per $100M traded
plot(y=apply(log1p((stocks.HFTflagsL.df)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily log. #HFT flags per 1 million shares traded", type="l", lwd=1,
     ylab="#flags", xlab="Date", ylim=c(0, 8), xaxt="n")
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflagsL.df))[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflagsL.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
lines(y=MovingAvg2(apply(log1p((stocks.HFTflagsL.df))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "1Y-mean(5/95%ile)"), cex=.8,
       lty=c(1,1,3), lwd=c(1,2,2), col=c("black", "black", "black"))

# 2.3d) Any other variable
test.df <- (stocks.reverse.min + stocks.reverse.max)
caption.main <- "Intraday return tail index"
caption.y <- "GP tail index"
yl <- quantile(test.df[], probs=c(.03, .97), na.rm=T)
plot(y=apply(((test.df)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main=paste("Daily", caption.main,"cross-sectional aggregates"), type="l", lwd=1,
     ylab=caption.y, xlab="Date", xaxt="n", ylim=yl)
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(apply(test.df[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=1)
lines(y=MovingAvg2(apply(test.df[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
lines(y=MovingAvg2(apply(test.df[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
      type="l", lwd=2, col="black", lty=3)
legend("topleft", legend=c("mean", "1Y-mean(mean)", "1Y-mean(5/95%ile)"), cex=.8,
       lty=c(1,1,3), lwd=c(1,2,2), col=c("black", "black", "black"))

# 2.4) EE and HFT activity combined plots --------------------------------------

# 2.4a) EED+EEU mean + HFT
plot(y=apply(((stocks.score.max-stocks.score.min)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Intraday extreme events and HFT activity", type="l", lwd=1, xaxt="n", col="grey50",
     ylab="EE score / detrended HFT", xlab="", ylim=c(2,13))
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(apply(((stocks.score.max-
                             stocks.score.min))[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", lwd=3, 
      col="black")
lines(y=MovingAvg2(apply(((stocks.score.max-
                             stocks.score.min))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", lwd=2, 
      col="grey50", lty=3)
lines(y=MovingAvg2(apply(((stocks.score.max-
                             stocks.score.min))[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", lwd=2, 
      col="grey50", lty=3)
# lines(y=3+2*MovingAvg2(apply((log1p(stocks.HFTflags.df))[range.idx, ], 1, 
#                            function(x) mean(x, na.rm=T, trim=.005)),252),
#       x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", 
#       lwd=2, lty=2, col="grey40")
# Detrended HFT measure
test <- MovingAvg2(100*hft.mins.sum.x/ (active.stocks.sum.x[range.idx] * daybars),252)
resid <- lm(test ~ seq(test))$residuals
test[!is.na(test)] <- resid
lines(y=6+0.7*test,
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", 
      lwd=5, lty=3, col="grey25")
legend("topleft", legend=c("mean IEE", "1Y-CMA(mean) IEE", "1Y-CMA(5/95%ile) IEE",
                           "detrended 1Y-CMA HFT"), cex=.8,
       lty=c(1,1,3,3), lwd=c(1,3,2,5), 
       col=c("grey50", "black", "grey50", "grey25"))

# 2.4b) EED+EEU DSBMOM mean + HFT
plot(y=apply(((stocks.dsbmom.max-stocks.dsbmom.min)/1)[range.idx, stocks.sel], 1, 
             function(x) mean(x, na.rm=T, trim=.005)), 
     x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))),
     main="Daily EE dsbmom", type="l", lwd=1, xaxt="n", col="grey40",
     ylab="EE dsbmom", xlab="Date", ylim=c(1,13))
axis.Date(side=1, x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), 
          at=axis.dates)
lines(y=MovingAvg2(apply(((stocks.dsbmom.max-
                             stocks.dsbmom.min)/1)[range.idx, stocks.sel], 1, 
                         function(x) mean(x, na.rm=T, trim=.005)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", lwd=3, 
      col="black")
lines(y=MovingAvg2(apply(((stocks.dsbmom.max-
                             stocks.dsbmom.min)/1)[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.05)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", lwd=2, 
      col="black", lty=3)
lines(y=MovingAvg2(apply(((stocks.dsbmom.max-
                             stocks.dsbmom.min)/1)[range.idx, stocks.sel], 1, 
                         function(x) quantile(x, na.rm=T, probs=.95)),252),
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", lwd=2, 
      col="black", lty=3)
# Detrended HFT measure
test <- MovingAvg2(100*hft.mins.sum.x/ (active.stocks.sum.x[range.idx] * daybars),252)
resid <- lm(test ~ seq(test))$residuals
test[!is.na(test)] <- resid
lines(y=6+0.7*test,
      x=(as.Date(rownames(stocks.HFTflags.df[range.idx, ]))), type="l", 
      lwd=4, lty=3, col="black")
legend("topleft", legend=c("mean", "1Y-CMA(mean)", "1Y-CMA(5/95%ile)",
                           "detrend. 1Y-CMA HFT"), cex=.8,
       lty=c(1,1,3,4), lwd=c(1,3,2,4), 
       col=c("grey40", "black", "black", "black"))

# 2.4z) Clean-up
rm(test)
rm(resid)
rm(axis.dates)

# 2.5) Correlation Analysis: Daily-Diff EE vs. HFT -----------------------------
rank.sel.fac <- apply (stocks.sizes.df[range.idx, stocks.sel], 2, mean, na.rm=T)
rank.sel.fac <- rank(rank.sel.fac)/length(rank.sel.fac)
rank.sel.fac <- cut(rank.sel.fac, breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1), 
                    include.lowest=T, labels=c("Q5", "Q4", "Q3", "Q2", "Q1"))

# 2.5a) EE ~ Flags
cor(Winsor(apply(DiffDf(log1p((stocks.HFTflags.df[range.idx, stocks.sel]))), 1, median, na.rm=T)),
    Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, median, na.rm=T)), use="p")
cor(Winsor(apply(DiffDf(log1p((stocks.HFTflags.df[range.idx, stocks.sel]))), 1, mean, na.rm=T, trim=.005)),
    Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, mean, na.rm=T, trim=.005)), use="p")
scatterplot(x=Winsor(apply(DiffDf(log1p((stocks.HFTflags.df[range.idx, stocks.sel]))), 1, mean, na.rm=T, trim=.005)),
            y=Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, mean, na.rm=T, trim=.005)),
            xlab="Daily log-diff. of mean(#HFT flags)", ylab="Daily diff. of EE score",
            main="Daily-diff EE vs. log. #HFT flags")

# 2.5b) EE ~ Flags/Vol
cor(Winsor(apply(DiffDf(log1p((stocks.HFTflagsV.df[range.idx, stocks.sel]))), 1, median, na.rm=T)),
    Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, median, na.rm=T)), use="p")
cor(Winsor(apply(DiffDf(log1p((stocks.HFTflagsV.df[range.idx, stocks.sel]))), 1, mean, na.rm=T, trim=.005)),
    Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, mean, na.rm=T, trim=.005)), use="p")
scatterplot(x=Winsor(apply(DiffDf(log1p((stocks.HFTflagsV.df[range.idx, stocks.sel]))), 1, mean, na.rm=T, trim=.005)),
            y=Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, mean, na.rm=T, trim=.005)),
            xlab="Daily log-diff. of mean(#HFT flags/volume)", ylab="Daily diff. of EE score",
            main="Daily-diff EE vs. log. #HFT flags/volume")

# 2.5c) EE ~ Flags/Liq
cor(Winsor(apply(DiffDf(log1p((stocks.HFTflagsL.df[range.idx, stocks.sel]))), 1, median, na.rm=T)),
    Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, median, na.rm=T)), use="p")
cor(Winsor(apply(DiffDf(log1p((stocks.HFTflagsL.df[range.idx, stocks.sel]))), 1, mean, na.rm=T, trim=.005)),
    Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, mean, na.rm=T, trim=.005)), use="p")
scatterplot(x=Winsor(apply(DiffDf(log1p((stocks.HFTflagsL.df[range.idx, stocks.sel]))), 1, mean, na.rm=T, trim=.005)),
            y=Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, stocks.sel], 1, mean, na.rm=T, trim=.005)),
            xlab="Daily log-diff. of mean(#HFT flags/$volume)", ylab="Daily diff. of EE score",
            main="Daily-diff EE vs. log. #HFT flags/$volume")

# 2.5d) EE ~ HFTxx by size quintiles
test.df <- stocks.HFTflagsL.df[range.idx,stocks.sel]
for (i in rev(levels(rank.sel.fac))) {
  sel.fac <- i
  print(i)
  print("cross-sectional medians")
  print(cor(Winsor(apply(DiffDf(log1p((test.df[, rank.sel.fac==sel.fac]))), 1, median, na.rm=T)),
            Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, rank.sel.fac==sel.fac], 1, median, na.rm=T)), use="p"))
  print("cross-sectional means")
  print(cor(Winsor(apply(DiffDf(log1p((test.df[, rank.sel.fac==sel.fac]))), 1, mean, na.rm=T, trim=.03)),
            Winsor(apply(DiffDf(stocks.score.max-stocks.score.min)[range.idx, rank.sel.fac==sel.fac], 1, mean, na.rm=T, trim=.03)), use="p"))  
}

# 2.5z) Clean-up
rm(sel.fac)
rm(rank.sel.fac)

# 2.6) Summary stats (cross-sectional, by stock) -------------------------------

# 2.6a) prepare variable for analysis
# stocks.HFTflags.df
# stocks.HFTflagsV.df
# stocks.HFTflagsL.df
# stocks.sizes.df / 1000
# stocks.liqs.df / 1000000
# stocks.tovs.df * 100
# stocks.prices.df
# stocks.score.max - stocks.score.min
# stocks.dsbmom.max - stocks.dsbmom.min
# -stocks.reverse.max * stocks.score.max - stocks.reverse.min * stocks.score.min

stocks.reverse.max2 <- stocks.reverse.max
stocks.reverse.max2[stocks.reverse.max2 < -300] <- -300
stocks.reverse.max2[stocks.reverse.max2 > 300] <- 300

stocks.reverse.min2 <- stocks.reverse.min
stocks.reverse.min2[stocks.reverse.min2 < -300] <- -300
stocks.reverse.min2[stocks.reverse.min2 > 300] <- 300

suffix <- "EE_reversal"
test.df <- -stocks.reverse.max2 * stocks.score.max - 
            stocks.reverse.min2 * stocks.score.min
test.df <- test.df[range.idx, stocks.sel]
years.fac <- years(as.chron(rownames(test.df)))

# 2.6b) full sample summary & yearly subsets
summ <- Summarize2(Winsor(apply(((test.df)/1), 2,
                                function(x) mean(Winsor(x, 0.005), na.rm=T)), 0.005))
summ.df <- data.frame(cbind(names(summ), summ))
names(summ.df) <- c("Stat", "Value")
summ.df
writeWorksheetToFile(paste("Results_", suffix, ".xlsx", sep=""), 
                     summ.df, "all_years")
for (i in levels(years.fac)) {
  print(i)
  summ <- Summarize2(Winsor(apply(test.df[years.fac==i, ], 2,
                                  function(x) mean(Winsor(x), na.rm=T)))) 
  summ.df <- data.frame(cbind(names(summ), summ))
  names(summ.df) <- c("Stat", "Value")
  print(summ.df)
  writeWorksheetToFile(paste("Results_", suffix, ".xlsx", sep=""), summ.df, i)
}

# 2.6c) yearly subsets in size quintiles (only for HFT & EE)
# size ranking
rank.sel.fac <- apply (stocks.sizes.df[range.idx, 
  !(names(stocks.sizes.df) %in% stocks.remove)], 2, mean, na.rm=T)
rank.sel.fac <- rank(rank.sel.fac)/length(rank.sel.fac)
rank.sel.fac <- cut(rank.sel.fac, breaks=c(0, 0.2, 0.4, 0.6, 0.8, 1), 
                    include.lowest=T, labels=c("Q5", "Q4", "Q3", "Q2", "Q1"))
# mean
for (s in rev(levels(rank.sel.fac))) {
  print(s)
  int.df <- test.df[, rank.sel.fac==s]
  for (i in levels(years.fac)) {
    print(i)
    print(paste("mean", 
                mean(Winsor(apply(int.df[years.fac==i, ], 2,
                                  function(x) mean(Winsor(x), na.rm=T))), na.rm=T)))
  }
}
# median
for (s in rev(levels(rank.sel.fac))) {
  print(s)
  int.df <- test.df[, rank.sel.fac==s]
  for (i in levels(years.fac)) {
    print(i)
    print(paste("median", 
                median(Winsor(apply(int.df[years.fac==i, ], 2,
                                    function(x) mean(Winsor(x), na.rm=T))), na.rm=T)))
  }
}
# --> 2.6) already processed and exported to excel, Paper Table design tbd

# 3. REGRESSION ANALYSIS -------------------------------------------------------

# 3.1) Sample Preparation ------------------------------------------------------
# 3.1a) Check variable distributions -------------------------------------------

write.csv (apply(stocks.score.min, 2, mean, na.rm=T), file="means.csv")
write.csv (apply(stocks.score.min, 2, min, na.rm=T), file="mins.csv")

hist(na.remove(stocks.score.max))
hist(na.remove(stocks.score.min))
hist(na.remove(log1p(stocks.score.max)))
hist(na.remove(log1p(-stocks.score.min)))

hist(na.remove(log(stocks.sizes.df))) # --> log
hist(na.remove(log(stocks.fcaps.df))) # --> log
hist(na.remove((stocks.betas.df)))
hist(na.remove((stocks.hlrs.df)))   # outliers!!!!
hist(na.remove((stocks.pvol.df)))   # outliers!!!!
summary(na.remove(stocks.hlrs.df))  
hist(na.remove(log(stocks.hlrs.df)))   # outliers!!!!
hist(na.remove((stocks.volas.df)))
summary(na.remove((stocks.volas.df))) # outliers
hist(na.remove(log(stocks.prices.df))) # --> log
hist(na.remove((stocks.tovs.df))) # outliers!!!
hist(na.remove(log(stocks.tovs.df))) # outliers!!!
hist(na.remove(log(stocks.liqs.df))) # outliers
hist(na.remove(log(stocks.vol.max))) # all vol.max/min have outliers
hist(na.remove(log(stocks.vol.max.l1)))
hist(na.remove(log(stocks.vol.max.l5)))
hist(na.remove(log(stocks.vol.max.l15)))
hist(na.remove(log(stocks.vol.min)))
hist(na.remove(log(stocks.vol.min.l1)))
hist(na.remove(log(stocks.vol.min.l5)))
hist(na.remove(log(stocks.vol.min.l15)))

hist(na.remove((stocks.hft.max)))
hist(na.remove((stocks.hft.max.l1)))
hist(na.remove((stocks.hft.max.l5)))
hist(na.remove((stocks.hft.max.l15)))
hist(na.remove((stocks.hft.min)))
hist(na.remove((stocks.hft.min.l1)))
hist(na.remove((stocks.hft.min.l5)))
hist(na.remove((stocks.hft.min.l15)))

hist(na.remove((stocks.idhl.mean.df)))
hist(na.remove((stocks.idhl.median.df)))
hist(na.remove((stocks.idhl.q95.df)))
hist(na.remove((stocks.idhl.q99.df)))
hist(na.remove((stocks.idhl.tail.df)))
hist(na.remove((stocks.idret.kurt.df)))
hist(na.remove((stocks.idret.max.df)))
hist(na.remove((stocks.idret.min.df)))
hist(na.remove((stocks.idret.mean.df)))
hist(na.remove((stocks.idret.meanabs.df)))
hist(na.remove((stocks.idret.q95abs.df)))
hist(na.remove((stocks.idret.q99abs.df)))
hist(na.remove((stocks.idret.sd.df)))
hist(na.remove((stocks.idret.tail.df)))

hist(na.remove((stocks.reverse.max2)))
hist(na.remove((stocks.reverse.min2)))

# 3.1b) select date range ------------------------------------------------------
# 2006:2010
range.idx <- 252:1498
rownames(stocks.HFTflags.df[range.idx,])
# 2006:2011
range.idx <- 252:1749
rownames(stocks.HFTflags.df[range.idx,])
# 2006:2012
range.idx <- 252:1996
rownames(stocks.HFTflags.df[range.idx,])
# "full"
range.idx <- 252:2161
rownames(stocks.HFTflags.df[range.idx,])

# REG NMS 1: 2007-05-09 to 2007-10-22 (NMS rollout +/- 2 months)
range.idx <- 588:701
rownames(stocks.HFTflags.df[range.idx,])
# # REG NMS 2: 2007-06-04 to 2007-09-28 (month-based cut)
# range.idx <- 604:685
# rownames(stocks.HFTflags.df[range.idx,])
# # REG NMS 3: 2007-04-09 to 2007-11-21 (NMS rollout +/- 3 months)
# range.idx <- 566:723
# rownames(stocks.HFTflags.df[range.idx,])
# # REG NMS 4: 2007-05-29 to 2007-09-28 (NMS-6 week period +/-)
# range.idx <- 601:685
# rownames(stocks.HFTflags.df[range.idx,])
# # REG NMS 5: 2007-05-09 to 2007-10-22 (NMS rollout -2/+4 months)
# range.idx <- 588:783
# rownames(stocks.HFTflags.df[range.idx,])

plot(y=apply(stocks.NMS.df[range.idx,], 1, sum, na.rm=T),
     x=as.Date(rownames(stocks.NMS.df[range.idx,])), type="l", lwd=2)
plot(log(hft.mins.sum.x[range.idx]), main="HFT mins")
plot(y=apply(log1p(stocks.HFTflags.df[range.idx,]), 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.NMS.df[range.idx,])), type="l", lwd=2)

summary(stocks.reverse.min)

plot(y=apply((stocks.reverse.min[range.idx,]+stocks.reverse.max[range.idx,]), 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.NMS.df[range.idx,])), type="l", lwd=2)


# SSB: 2008-08-01 to 2008-11-26
range.idx <- 910:960
rownames(stocks.HFTflags.df[range.idx,])
plot(y=apply(stocks.SSB.df[range.idx,], 1, sum, na.rm=T),
     x=as.Date(rownames(stocks.SSB.df[range.idx,])), type="l", lwd=2)

# NAB - Naked Access Ban: 2011-11-30 +/- 2 months
range.idx <- 1688:1769
rownames(stocks.HFTflags.df[range.idx,])
plot(y=apply(stocks.HFTflagsV.df[range.idx,], 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.SSB.df[range.idx,])), type="l", lwd=2)
plot(y=apply(stocks.hlrs.df[range.idx,], 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.SSB.df[range.idx,])), type="l", lwd=2)
plot(y=apply(stocks.prices.df[range.idx,], 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.SSB.df[range.idx,])), type="l", lwd=2)

# NAB 2010 comparison
range.idx <- 1437:1518
rownames(stocks.HFTflags.df[range.idx,])
plot(y=apply(stocks.hlrs.df[range.idx,], 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.SSB.df[range.idx,])), type="l", lwd=2)

# NAB 2012 comparison
range.idx <- 1937:2017
rownames(stocks.HFTflags.df[range.idx,])
plot(y=apply(stocks.hlrs.df[range.idx,], 1, mean, na.rm=T),
     x=as.Date(rownames(stocks.SSB.df[range.idx,])), type="l", lwd=2)

# QCH - NASDAQ CHANNEL UPGRADE
range.idx <- 1688:1703
rownames(stocks.HFTflags.df[range.idx,])


# remove 2008-11-20 if it is included in the sample
range.idx <- range.idx[-which(rownames(stocks.HFTflags.df[range.idx,])==
                                "2008-11-20")]


# 3.1c) Check data completeness and filter symbols -----------------------------
stocks.remove <- c("AMRN.Q", "EFUT.Q", "FFHL.Q", "ROSG.Q", "UNXL.Q", "VHC.A")
stocks.sel <- !(names(stocks.HFTflags.df) %in% stocks.remove)

for (i in seq_along(ls(pattern="^stocks.*"))) {
  if (ls (pattern="^stocks.*")[i] != "stocks.sel" & 
        ls (pattern="^stocks.*")[i] != "stocks.remove") {
    cur.name <- ls (pattern="^stocks.*")[i]
    test <- apply (get(cur.name)[range.idx,stocks.sel], 2, function(x) any(is.na(x)))
    print(cur.name)
    print(summary(test))
  }
}  

# data completeness check (take out stocks with NAs in selected date range)
GetCompleteStocks <- function() {
  stocks.completeV <- apply (LagDf(get("stocks.volas.df"))[range.idx,], 2, 
                             function(x) any(is.na(x)))
  summary(stocks.completeV)
  
  stocks.completeE1 <- apply (LagDf(get("stocks.score.max"))[range.idx,], 2, 
                              function(x) any(is.na(x)) )
  summary(stocks.completeE1)
  stocks.completeE2 <- apply (LagDf(get("stocks.score.min"))[range.idx,], 2, 
                              function(x) any(is.na(x)) )
  summary(stocks.completeE2)
  
  stocks.pricefilt <- apply (LagDf(stocks.prices.df)[range.idx,], 2, 
                             function(x) any((x)<5 | (x)>1000))
  stocks.pricefilt[is.na(stocks.pricefilt)] <- T
  summary(stocks.pricefilt | stocks.completeV)
  
  # clean intraday return distribution check
  # filters out days with missing/bar-filled data and/or no trading activity
  stocks.distfilt <- apply (get("stocks.idhl.mean.df")[range.idx,], 2, 
                            function(x) any((x==0 | is.na(x))))
  summary(stocks.distfilt)
  summary(stocks.distfilt | stocks.completeV)
  summary(stocks.distfilt | stocks.pricefilt | stocks.completeV)
  
  stocks.sizefilt <- apply (stocks.sizes.df[range.idx,], 2, function(x) 
                            any(mean(x, na.rm=T) < 250 | is.na(x) ) )
  summary(stocks.sizefilt | stocks.pricefilt | stocks.completeV | stocks.distfilt)
  
  # data required for 1st stage regression
  stocks.complete <- (stocks.completeV | stocks.pricefilt)
  summary(stocks.complete)
  # data required for EEU/EED regressions
  stocks.complete <- (stocks.completeV | stocks.pricefilt | stocks.distfilt |
                      stocks.completeE1 | stocks.completeE2 | stocks.sizefilt)
  return (stocks.complete)
}

stocksel.complete <- GetCompleteStocks()
summary(stocksel.complete)
stocksel.complete <- stocksel.complete | (!stocks.sel)
summary(stocksel.complete)


# 3.2) Build Panel Dataframe ---------------------------------------------------
# 3.2a) "Panelize" individual variables ----------------------------------------
# define vol/liq-adjusted HFT measures
stocks.HFTflagsV.df <- stocks.HFTflags.df/((stocks.liqs.df/stocks.prices.df)/1000000)
stocks.HFTflagsL.df <- stocks.HFTflags.df/((stocks.liqs.df)/100000000)

# Move process into function to keep workspace clean
ConstructPanel <- function (off=T) {  
  # encapsulates all panel variable definitions
  # off=T: deactivates optional standardization of selectedvariables
  
  # HFL - HFT flags
  stocks.HFL.pdf <- melt (as.matrix(StdDf(stocks.HFTflags.df[range.idx, !stocksel.complete], off)))
  stocks.HFL.pdf <- plm.data (stocks.HFL.pdf, index=c("X2", "X1"))
  names(stocks.HFL.pdf) <- c("symbol", "date", "HFL")

  # HFLV - HFT flags / 1M share volume
  stocks.HFLV.pdf <- melt (as.matrix(StdDf(stocks.HFTflagsV.df[range.idx, !stocksel.complete], off)))
  stocks.HFLV.pdf <- plm.data (stocks.HFLV.pdf, index=c("X2", "X1"))
  names(stocks.HFLV.pdf) <- c("symbol", "date", "HFLV")
  
  # HFLlag - HFT flags
  stocks.HFLlag.pdf <- melt (as.matrix((StdDf(LagDf(stocks.HFTflags.df)[range.idx, !stocksel.complete], off))))
  stocks.HFLlag.pdf <- plm.data (stocks.HFLlag.pdf, index=c("X2", "X1"))
  names(stocks.HFLlag.pdf) <- c("symbol", "date", "HFLlag")
  
  # HFLVlag - HFT flags / 1M share volume
  stocks.HFLVlag.pdf <- melt (as.matrix((StdDf(LagDf(stocks.HFTflagsV.df)[range.idx, !stocksel.complete], off))))
  stocks.HFLVlag.pdf <- plm.data (stocks.HFLVlag.pdf, index=c("X2", "X1"))
  names(stocks.HFLVlag.pdf) <- c("symbol", "date", "HFLVlag")

  # HFLL - HFT flags / 100M $
  stocks.HFLL.pdf <- melt (as.matrix(StdDf(stocks.HFTflagsL.df[range.idx, !stocksel.complete], off)))
  stocks.HFLL.pdf <- plm.data (stocks.HFLL.pdf, index=c("X2", "X1"))
  names(stocks.HFLL.pdf) <- c("symbol", "date", "HFLL")

  # HFLLlag - HFT flags / 100M $
  stocks.HFLLlag.pdf <- melt (as.matrix(StdDf(LagDf(stocks.HFTflagsL.df)[range.idx, !stocksel.complete], off)))
  stocks.HFLLlag.pdf <- plm.data (stocks.HFLLlag.pdf, index=c("X2", "X1"))
  names(stocks.HFLLlag.pdf) <- c("symbol", "date", "HFLLlag")
  
  # HPQ - HFT flagged quote rate
  stocks.HPQ.pdf <- melt (as.matrix(10000*stocks.HFTpquotes.df[range.idx, !stocksel.complete]))
  stocks.HPQ.pdf <- plm.data (stocks.HPQ.pdf, index=c("X2", "X1"))
  names(stocks.HPQ.pdf) <- c("symbol", "date", "HPQ")
  
  # HPQL calculated next step...
  
  # NMS (REG NMS Rollout 2007 July/August)
  stocks.NMS.pdf <- melt (as.matrix(stocks.NMS.df[range.idx, !stocksel.complete]))
  stocks.NMS.pdf <- plm.data (stocks.NMS.pdf, index=c("X2", "X1"))
  names(stocks.NMS.pdf) <- c("symbol", "date", "NMS")
  
  # SSB (SEC Short-Sale Ban 2008 Sep/Oct)
  stocks.SSB.pdf <- melt (as.matrix(stocks.SSB.df[range.idx, !stocksel.complete]))
  stocks.SSB.pdf <- plm.data (stocks.SSB.pdf, index=c("X2", "X1"))
  names(stocks.SSB.pdf) <- c("symbol", "date", "SSB")
  
  # SIZE (ln market cap) -- ATTENTION: LAG
  stocks.SIZE.pdf <- melt (log(as.matrix(LagDf(stocks.sizes.df)[range.idx, !stocksel.complete])))
  stocks.SIZE.pdf <- plm.data (stocks.SIZE.pdf, index=c("X2", "X1"))
  names(stocks.SIZE.pdf) <- c("symbol", "date", "SIZE")
  
  # FLT (ln float cap) -- ATTENTION: LAG
  stocks.FLT.pdf <- melt (log(as.matrix(LagDf(stocks.fcaps.df)[range.idx, !stocksel.complete])))
  stocks.FLT.pdf <- plm.data (stocks.FLT.pdf, index=c("X2", "X1"))
  names(stocks.FLT.pdf) <- c("symbol", "date", "FLT")
  
  # VOLA (classic quarterly vola) -- ATTENTION: LAG
  stocks.VOLA.pdf <- melt (as.matrix(LagDf(stocks.volas.df)[range.idx, !stocksel.complete]))
  stocks.VOLA.pdf <- plm.data (stocks.VOLA.pdf, index=c("X2", "X1"))
  names(stocks.VOLA.pdf) <- c("symbol", "date", "VOLA")
  
  # BETA (classic quarterly vola) -- alreaddy lagged in source
  stocks.BETA.pdf <- melt (as.matrix(stocks.betas.df[range.idx, !stocksel.complete]))
  stocks.BETA.pdf <- plm.data (stocks.BETA.pdf, index=c("X2", "X1"))
  names(stocks.BETA.pdf) <- c("symbol", "date", "BETA")
  
  # VOLE (HLR extremum-based vola)
  stocks.VOLE.pdf <- melt (as.matrix(stocks.hlrs.df[range.idx, !stocksel.complete]))
  stocks.VOLE.pdf <- plm.data (stocks.VOLE.pdf, index=c("X2", "X1"))
  names(stocks.VOLE.pdf) <- c("symbol", "date", "VOLE")
  
  # VOLP (Parkinson Vola Estimate) -- ATTENTION: LAG
  stocks.VOLP.pdf <- melt (as.matrix(LagDf(stocks.pvol.df)[range.idx, !stocksel.complete]))
  stocks.VOLP.pdf <- plm.data (stocks.VOLP.pdf, index=c("X2", "X1"))
  names(stocks.VOLP.pdf) <- c("symbol", "date", "VOLP")

  # PR (1/PRICE) -- ATTENTION: LAG
  stocks.PR.pdf <- melt (as.matrix(LagDf(stocks.prices.df)[range.idx, !stocksel.complete]))
  stocks.PR.pdf <- plm.data (stocks.PR.pdf, index=c("X2", "X1"))
  names(stocks.PR.pdf) <- c("symbol", "date", "PR")
  
  # TOV (Turnover)
  stocks.TOV.pdf <- melt (as.matrix(stocks.tovs.df[range.idx, !stocksel.complete]))
  stocks.TOV.pdf <- plm.data (stocks.TOV.pdf, index=c("X2", "X1"))
  names(stocks.TOV.pdf) <- c("symbol", "date", "TOV")

  # TOVMA (Turnover) -- ATTENTION: LAG
  stocks.TOVMA.pdf <- melt (as.matrix(LagDf(stocks.tovsMA.df)[range.idx, !stocksel.complete]))
  stocks.TOVMA.pdf <- plm.data (stocks.TOVMA.pdf, index=c("X2", "X1"))
  names(stocks.TOVMA.pdf) <- c("symbol", "date", "TOVMA")  
  
  # LIQ (ln $Liquidity)
  stocks.LIQ.pdf <- melt (log(as.matrix(stocks.liqs.df[range.idx, !stocksel.complete])))
  stocks.LIQ.pdf <- plm.data (stocks.LIQ.pdf, index=c("X2", "X1"))
  names(stocks.LIQ.pdf) <- c("symbol", "date", "LIQ")
  
  # VOL (volume)
  stocks.VOL.pdf <- 
    melt (as.matrix((stocks.liqs.df/stocks.prices.df)[range.idx, !stocksel.complete]))
  stocks.VOL.pdf <- plm.data (stocks.VOL.pdf, index=c("X2", "X1"))
  names(stocks.VOL.pdf) <- c("symbol", "date", "VOL")
  
  # EE Score Min/Max -- daily up/down events
  #  **** ATTENTION: OPTIONAL STANDARDIZATION FUNCTION APPLIED TO EEU+EED ****
  # EEU
  stocks.EEU.pdf <- melt (as.matrix(StdDf(stocks.score.max[range.idx, !stocksel.complete], off)))
  stocks.EEU.pdf <- plm.data (stocks.EEU.pdf, index=c("X2", "X1"))
  names(stocks.EEU.pdf) <- c("symbol", "date", "EEU")
  
  # EED
  stocks.EED.pdf <- melt (as.matrix(StdDf(-stocks.score.min[range.idx, !stocksel.complete], off)))
  stocks.EED.pdf <- plm.data (stocks.EED.pdf, index=c("X2", "X1"))
  names(stocks.EED.pdf) <- c("symbol", "date", "EED")
  
  # LAG 1 versions of EEU & EED
  # EEUL
  stocks.EEUL.pdf <- melt (as.matrix(StdDf(LagDf(stocks.score.max)[range.idx, !stocksel.complete], off)))
  stocks.EEUL.pdf <- plm.data (stocks.EEUL.pdf, index=c("X2", "X1"))
  names(stocks.EEUL.pdf) <- c("symbol", "date", "EEUL")
  
  # EEDL
  stocks.EEDL.pdf <- melt (as.matrix(StdDf(LagDf(-stocks.score.min)[range.idx, !stocksel.complete], off)))
  stocks.EEDL.pdf <- plm.data (stocks.EEDL.pdf, index=c("X2", "X1"))
  names(stocks.EEDL.pdf) <- c("symbol", "date", "EEDL")
  #  **** ATTENTION: OPTIONAL STANDARDIZATION FUNCTION APPLIED TO EEU+EED ****
  
  # REVU (upside reversal, in %)
  stocks.REVU.pdf <- 
    melt (as.matrix((stocks.reverse.max)[range.idx, !stocksel.complete]))
  stocks.REVU.pdf <- plm.data (stocks.REVU.pdf, index=c("X2", "X1"))
  names(stocks.REVU.pdf) <- c("symbol", "date", "REVU")
  
  # REVD (upside reversal, in %)
  stocks.REVD.pdf <- 
    melt (as.matrix((stocks.reverse.min)[range.idx, !stocksel.complete]))
  stocks.REVD.pdf <- plm.data (stocks.REVD.pdf, index=c("X2", "X1"))
  names(stocks.REVD.pdf) <- c("symbol", "date", "REVD")
  
  # EEUT
  stocks.EEUT.pdf <- melt (as.matrix(stocks.score.max.t[range.idx, !stocksel.complete]))
  stocks.EEUT.pdf <- plm.data (stocks.EEUT.pdf, index=c("X2", "X1"))
  names(stocks.EEUT.pdf) <- c("symbol", "date", "EEUT")
  
  # EEDT
  stocks.EEDT.pdf <- melt (as.matrix(stocks.score.min.t[range.idx, !stocksel.complete]))
  stocks.EEDT.pdf <- plm.data (stocks.EEDT.pdf, index=c("X2", "X1"))
  names(stocks.EEDT.pdf) <- c("symbol", "date", "EEDT")
  
  # EE Raw Size Min/Max -- daily up/down events
  # EEMU
  stocks.EEMU.pdf <- melt (as.matrix(StdDf(stocks.dsbmom.max[range.idx, !stocksel.complete], off)))
  stocks.EEMU.pdf <- plm.data (stocks.EEMU.pdf, index=c("X2", "X1"))
  names(stocks.EEMU.pdf) <- c("symbol", "date", "EEMU")
  
  # EEMD
  stocks.EEMD.pdf <- melt (as.matrix(StdDf(-stocks.dsbmom.min[range.idx, !stocksel.complete], off)))
  stocks.EEMD.pdf <- plm.data (stocks.EEMD.pdf, index=c("X2", "X1"))
  names(stocks.EEMD.pdf) <- c("symbol", "date", "EEMD")
  
  # LAG 1 versions of EEMU & EEMD
  # EEMUL
  stocks.EEMUL.pdf <- melt (as.matrix(StdDf(LagDf(stocks.dsbmom.max)[range.idx, !stocksel.complete], off)))
  stocks.EEMUL.pdf <- plm.data (stocks.EEMUL.pdf, index=c("X2", "X1"))
  names(stocks.EEMUL.pdf) <- c("symbol", "date", "EEMUL")
  
  # EEMDL
  stocks.EEMDL.pdf <- melt (as.matrix(StdDf(LagDf(-stocks.dsbmom.min)[range.idx, !stocksel.complete], off)))
  stocks.EEMDL.pdf <- plm.data (stocks.EEMDL.pdf, index=c("X2", "X1"))
  names(stocks.EEMDL.pdf) <- c("symbol", "date", "EEMDL")
  #  **** ATTENTION: STANDARDIZED EEU+EEDL ****
  
  # HFLU0
  stocks.HFLU0.pdf <- melt (as.matrix(stocks.hft.max[range.idx, !stocksel.complete]))
  stocks.HFLU0.pdf <- plm.data (stocks.HFLU0.pdf, index=c("X2", "X1"))
  names(stocks.HFLU0.pdf) <- c("symbol", "date", "HFLU0")
  
  # HFLD0
  stocks.HFLD0.pdf <- melt (as.matrix(stocks.hft.min[range.idx, !stocksel.complete]))
  stocks.HFLD0.pdf <- plm.data (stocks.HFLD0.pdf, index=c("X2", "X1"))
  names(stocks.HFLD0.pdf) <- c("symbol", "date", "HFLD0")
  
  # HFLU1
  stocks.HFLU1.pdf <- melt (as.matrix(stocks.hft.max.l1[range.idx, !stocksel.complete]))
  stocks.HFLU1.pdf <- plm.data (stocks.HFLU1.pdf, index=c("X2", "X1"))
  names(stocks.HFLU1.pdf) <- c("symbol", "date", "HFLU1")
  
  # HFLD1
  stocks.HFLD1.pdf <- melt (as.matrix(stocks.hft.min.l1[range.idx, !stocksel.complete]))
  stocks.HFLD1.pdf <- plm.data (stocks.HFLD1.pdf, index=c("X2", "X1"))
  names(stocks.HFLD1.pdf) <- c("symbol", "date", "HFLD1")
  
  # HFLU5
  stocks.HFLU5.pdf <- melt (as.matrix(stocks.hft.max.l5[range.idx, !stocksel.complete]))
  stocks.HFLU5.pdf <- plm.data (stocks.HFLU5.pdf, index=c("X2", "X1"))
  names(stocks.HFLU5.pdf) <- c("symbol", "date", "HFLU5")
  
  # HFLD5
  stocks.HFLD5.pdf <- melt (as.matrix(stocks.hft.min.l5[range.idx, !stocksel.complete]))
  stocks.HFLD5.pdf <- plm.data (stocks.HFLD5.pdf, index=c("X2", "X1"))
  names(stocks.HFLD5.pdf) <- c("symbol", "date", "HFLD5")
  
  # HFLU15
  stocks.HFLU15.pdf <- melt (as.matrix(stocks.hft.max.l15[range.idx, !stocksel.complete]))
  stocks.HFLU15.pdf <- plm.data (stocks.HFLU15.pdf, index=c("X2", "X1"))
  names(stocks.HFLU15.pdf) <- c("symbol", "date", "HFLU15")
  
  # HFLD15
  stocks.HFLD15.pdf <- melt (as.matrix(stocks.hft.min.l15[range.idx, !stocksel.complete]))
  stocks.HFLD15.pdf <- plm.data (stocks.HFLD15.pdf, index=c("X2", "X1"))
  names(stocks.HFLD15.pdf) <- c("symbol", "date", "HFLD15")
  
  # VOLU0
  stocks.VOLU0.pdf <- melt (as.matrix(stocks.vol.max[range.idx, !stocksel.complete]))
  stocks.VOLU0.pdf <- plm.data (stocks.VOLU0.pdf, index=c("X2", "X1"))
  names(stocks.VOLU0.pdf) <- c("symbol", "date", "VOLU0")
  
  # VOLD0
  stocks.VOLD0.pdf <- melt (as.matrix(stocks.vol.min[range.idx, !stocksel.complete]))
  stocks.VOLD0.pdf <- plm.data (stocks.VOLD0.pdf, index=c("X2", "X1"))
  names(stocks.VOLD0.pdf) <- c("symbol", "date", "VOLD0")
  
  # VOLU1
  stocks.VOLU1.pdf <- melt (as.matrix(stocks.vol.max.l1[range.idx, !stocksel.complete]))
  stocks.VOLU1.pdf <- plm.data (stocks.VOLU1.pdf, index=c("X2", "X1"))
  names(stocks.VOLU1.pdf) <- c("symbol", "date", "VOLU1")
  
  # VOLD1
  stocks.VOLD1.pdf <- melt (as.matrix(stocks.vol.min.l1[range.idx, !stocksel.complete]))
  stocks.VOLD1.pdf <- plm.data (stocks.VOLD1.pdf, index=c("X2", "X1"))
  names(stocks.VOLD1.pdf) <- c("symbol", "date", "VOLD1")
  
  # VOLU5
  stocks.VOLU5.pdf <- melt (as.matrix(stocks.vol.max.l5[range.idx, !stocksel.complete]))
  stocks.VOLU5.pdf <- plm.data (stocks.VOLU5.pdf, index=c("X2", "X1"))
  names(stocks.VOLU5.pdf) <- c("symbol", "date", "VOLU5")
  
  # VOLD5
  stocks.VOLD5.pdf <- melt (as.matrix(stocks.vol.min.l5[range.idx, !stocksel.complete]))
  stocks.VOLD5.pdf <- plm.data (stocks.VOLD5.pdf, index=c("X2", "X1"))
  names(stocks.VOLD5.pdf) <- c("symbol", "date", "VOLD5")
  
  # VOLU15
  stocks.VOLU15.pdf <- melt (as.matrix(stocks.vol.max.l15[range.idx, !stocksel.complete]))
  stocks.VOLU15.pdf <- plm.data (stocks.VOLU15.pdf, index=c("X2", "X1"))
  names(stocks.VOLU15.pdf) <- c("symbol", "date", "VOLU15")
  
  # VOLD15
  stocks.VOLD15.pdf <- melt (as.matrix(stocks.vol.min.l15[range.idx, !stocksel.complete]))
  stocks.VOLD15.pdf <- plm.data (stocks.VOLD15.pdf, index=c("X2", "X1"))
  names(stocks.VOLD15.pdf) <- c("symbol", "date", "VOLD15")
#   
#   # RVOLU0
#   stocks.RVOLU0.pdf <- melt (as.matrix(stocks.relvol.max[range.idx, !stocksel.complete]))
#   stocks.RVOLU0.pdf <- plm.data (stocks.RVOLU0.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLU0.pdf) <- c("symbol", "date", "RVOLU0")
#   
#   # RVOLD0
#   stocks.RVOLD0.pdf <- melt (as.matrix(stocks.relvol.min[range.idx, !stocksel.complete]))
#   stocks.RVOLD0.pdf <- plm.data (stocks.RVOLD0.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLD0.pdf) <- c("symbol", "date", "RVOLD0")
#   
#   # RVOLU1
#   stocks.RVOLU1.pdf <- melt (as.matrix(stocks.relvol.max.l1[range.idx, !stocksel.complete]))
#   stocks.RVOLU1.pdf <- plm.data (stocks.RVOLU1.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLU1.pdf) <- c("symbol", "date", "RVOLU1")
#   
#   # RVOLD1
#   stocks.RVOLD1.pdf <- melt (as.matrix(stocks.relvol.min.l1[range.idx, !stocksel.complete]))
#   stocks.RVOLD1.pdf <- plm.data (stocks.RVOLD1.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLD1.pdf) <- c("symbol", "date", "RVOLD1")
#   
#   # RVOLU5
#   stocks.RVOLU5.pdf <- melt (as.matrix(stocks.relvol.max.l5[range.idx, !stocksel.complete]))
#   stocks.RVOLU5.pdf <- plm.data (stocks.RVOLU5.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLU5.pdf) <- c("symbol", "date", "RVOLU5")
#   
#   # RVOLD5
#   stocks.RVOLD5.pdf <- melt (as.matrix(stocks.relvol.min.l5[range.idx, !stocksel.complete]))
#   stocks.RVOLD5.pdf <- plm.data (stocks.RVOLD5.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLD5.pdf) <- c("symbol", "date", "RVOLD5")
#   
#   # RVOLU15
#   stocks.RVOLU15.pdf <- melt (as.matrix(stocks.relvol.max.l15[range.idx, !stocksel.complete]))
#   stocks.RVOLU15.pdf <- plm.data (stocks.RVOLU15.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLU15.pdf) <- c("symbol", "date", "RVOLU15")
#   
#   # RVOLD15
#   stocks.RVOLD15.pdf <- melt (as.matrix(stocks.relvol.min.l15[range.idx, !stocksel.complete]))
#   stocks.RVOLD15.pdf <- plm.data (stocks.RVOLD15.pdf, index=c("X2", "X1"))
#   names(stocks.RVOLD15.pdf) <- c("symbol", "date", "RVOLD15")  
#   
#   # IEM
#   stocks.IEM.pdf <- melt (as.matrix(stocks.idhl.mean.df[range.idx, !stocksel.complete]))
#   stocks.IEM.pdf <- plm.data (stocks.IEM.pdf, index=c("X2", "X1"))
#   names(stocks.IEM.pdf) <- c("symbol", "date", "IEM")
#   
#   # IEMD
#   stocks.IEMD.pdf <- melt (as.matrix(stocks.idhl.median.df[range.idx, !stocksel.complete]))
#   stocks.IEMD.pdf <- plm.data (stocks.IEMD.pdf, index=c("X2", "X1"))
#   names(stocks.IEMD.pdf) <- c("symbol", "date", "IEMD")
#   
#   # IEQ95
#   stocks.IEQ95.pdf <- melt (as.matrix(stocks.idhl.q95.df[range.idx, !stocksel.complete]))
#   stocks.IEQ95.pdf <- plm.data (stocks.IEQ95.pdf, index=c("X2", "X1"))
#   names(stocks.IEQ95.pdf) <- c("symbol", "date", "IEQ95")
#   
#   # IEQ99
#   stocks.IEQ99.pdf <- melt (as.matrix(stocks.idhl.q99.df[range.idx, !stocksel.complete]))
#   stocks.IEQ99.pdf <- plm.data (stocks.IEQ99.pdf, index=c("X2", "X1"))
#   names(stocks.IEQ99.pdf) <- c("symbol", "date", "IEQ99")
#   
#   # IET
#   stocks.IET.pdf <- melt (as.matrix(stocks.idhl.tail.df[range.idx, !stocksel.complete]))
#   stocks.IET.pdf <- plm.data (stocks.IET.pdf, index=c("X2", "X1"))
#   names(stocks.IET.pdf) <- c("symbol", "date", "IET")
#   
#   # IRM
#   stocks.IRM.pdf <- melt (as.matrix(stocks.idret.mean.df[range.idx, !stocksel.complete]))
#   stocks.IRM.pdf <- plm.data (stocks.IRM.pdf, index=c("X2", "X1"))
#   names(stocks.IRM.pdf) <- c("symbol", "date", "IRM")
#   
#   # IRQ95
#   stocks.IRQ95.pdf <- melt (as.matrix(stocks.idret.q95abs.df[range.idx, !stocksel.complete]))
#   stocks.IRQ95.pdf <- plm.data (stocks.IRQ95.pdf, index=c("X2", "X1"))
#   names(stocks.IRQ95.pdf) <- c("symbol", "date", "IRQ95")
#   
#   # IRQ99
#   stocks.IRQ99.pdf <- melt (as.matrix(stocks.idret.q99abs.df[range.idx, !stocksel.complete]))
#   stocks.IRQ99.pdf <- plm.data (stocks.IRQ99.pdf, index=c("X2", "X1"))
#   names(stocks.IRQ99.pdf) <- c("symbol", "date", "IRQ99")
#   
#   # IRT
#   stocks.IRT.pdf <- melt (as.matrix(stocks.idret.tail.df[range.idx, !stocksel.complete]))
#   stocks.IRT.pdf <- plm.data (stocks.IRT.pdf, index=c("X2", "X1"))
#   names(stocks.IRT.pdf) <- c("symbol", "date", "IRT")
# 
#   # IRT5
#   stocks.IRT5.pdf <- melt (as.matrix(stocks.idret.tail5.df[range.idx, !stocksel.complete]))
#   stocks.IRT5.pdf <- plm.data (stocks.IRT5.pdf, index=c("X2", "X1"))
#   names(stocks.IRT5.pdf) <- c("symbol", "date", "IRT5")
# 
#   # IRT15
#   stocks.IRT15.pdf <- melt (as.matrix(stocks.idret.tail15.df[range.idx, !stocksel.complete]))
#   stocks.IRT15.pdf <- plm.data (stocks.IRT15.pdf, index=c("X2", "X1"))
#   names(stocks.IRT15.pdf) <- c("symbol", "date", "IRT15")
#   
#   # IRK
#   stocks.IRK.pdf <- melt (as.matrix(stocks.idret.kurt.df[range.idx, !stocksel.complete]))
#   stocks.IRK.pdf <- plm.data (stocks.IRK.pdf, index=c("X2", "X1"))
#   names(stocks.IRK.pdf) <- c("symbol", "date", "IRK")
# 
#   # IRK5
#   stocks.IRK5.pdf <- melt (as.matrix(stocks.idret.kurt5.df[range.idx, !stocksel.complete]))
#   stocks.IRK5.pdf <- plm.data (stocks.IRK5.pdf, index=c("X2", "X1"))
#   names(stocks.IRK5.pdf) <- c("symbol", "date", "IRK5")  
# 
#   # IRK15
#   stocks.IRK15.pdf <- melt (as.matrix(stocks.idret.kurt15.df[range.idx, !stocksel.complete]))
#   stocks.IRK15.pdf <- plm.data (stocks.IRK15.pdf, index=c("X2", "X1"))
#   names(stocks.IRK15.pdf) <- c("symbol", "date", "IRK15")  
#     
#   # IRMA
#   stocks.IRMA.pdf <- melt (as.matrix(stocks.idret.meanabs.df[range.idx, !stocksel.complete]))
#   stocks.IRMA.pdf <- plm.data (stocks.IRMA.pdf, index=c("X2", "X1"))
#   names(stocks.IRMA.pdf) <- c("symbol", "date", "IRMA")
#   
#   # IRMDA
#   stocks.IRMDA.pdf <- melt (as.matrix(stocks.idret.medianabs.df[range.idx, !stocksel.complete]))
#   stocks.IRMDA.pdf <- plm.data (stocks.IRMDA.pdf, index=c("X2", "X1"))
#   names(stocks.IRMDA.pdf) <- c("symbol", "date", "IRMDA")
#   
#   # IRS
#   stocks.IRS.pdf <- melt (as.matrix(stocks.idret.sd.df[range.idx, !stocksel.complete]))
#   stocks.IRS.pdf <- plm.data (stocks.IRS.pdf, index=c("X2", "X1"))
#   names(stocks.IRS.pdf) <- c("symbol", "date", "IRS")
#   
#   # IRS5
#   stocks.IRS5.pdf <- melt (as.matrix(stocks.idret.sd5.df[range.idx, !stocksel.complete]))
#   stocks.IRS5.pdf <- plm.data (stocks.IRS5.pdf, index=c("X2", "X1"))
#   names(stocks.IRS5.pdf) <- c("symbol", "date", "IRS5")
# 
#   # IRS15
#   stocks.IRS15.pdf <- melt (as.matrix(stocks.idret.sd15.df[range.idx, !stocksel.complete]))
#   stocks.IRS15.pdf <- plm.data (stocks.IRS15.pdf, index=c("X2", "X1"))
#   names(stocks.IRS15.pdf) <- c("symbol", "date", "IRS15")  
#   
#   # IRMIN
#   stocks.IRMIN.pdf <- melt (as.matrix(stocks.idret.min.df[range.idx, !stocksel.complete]))
#   stocks.IRMIN.pdf <- plm.data (stocks.IRMIN.pdf, index=c("X2", "X1"))
#   names(stocks.IRMIN.pdf) <- c("symbol", "date", "IRMIN")
#   
#   # IRMAX
#   stocks.IRMAX.pdf <- melt (as.matrix(stocks.idret.max.df[range.idx, !stocksel.complete]))
#   stocks.IRMAX.pdf <- plm.data (stocks.IRMAX.pdf, index=c("X2", "X1"))
#   names(stocks.IRMAX.pdf) <- c("symbol", "date", "IRMAX")
  
  # 3b) build combined regression panel ------------------------------------------
  stocks.panel.pdf <- stocks.HFL.pdf
  stocks.panel.pdf$HFLV <- stocks.HFLV.pdf$HFLV
  stocks.panel.pdf$HFLL <- stocks.HFLL.pdf$HFLL
  stocks.panel.pdf$HPQV <- stocks.HPQ.pdf$HPQ
  stocks.panel.pdf$HPQL <- stocks.HPQ.pdf$HPQ * (stocks.PR.pdf$PR / 10)
  stocks.panel.pdf$HFLlag <- stocks.HFLlag.pdf$HFLlag
  stocks.panel.pdf$HFLVlag <- stocks.HFLVlag.pdf$HFLVlag
  stocks.panel.pdf$HFLLlag <- stocks.HFLLlag.pdf$HFLLlag
  
  stocks.panel.pdf$HFLlog <- log1p(stocks.panel.pdf$HFL)
  stocks.panel.pdf$HFLVlog <- log1p(stocks.panel.pdf$HFLV)
  stocks.panel.pdf$HFLLlog <- log1p(stocks.panel.pdf$HFLL)
  stocks.panel.pdf$HPQVlog <- log1p(stocks.panel.pdf$HPQV)
  stocks.panel.pdf$HPQLlog <- log1p(stocks.panel.pdf$HPQL)
  stocks.panel.pdf$HFLlola <- log1p(stocks.panel.pdf$HFLlag)
  stocks.panel.pdf$HFLVlola <- log1p(stocks.panel.pdf$HFLVlag)
  stocks.panel.pdf$HFLLlola <- log1p(stocks.panel.pdf$HFLLlag)
  
  stocks.panel.pdf$BETA <- stocks.BETA.pdf$BETA
  stocks.panel.pdf$VOLA <- stocks.VOLA.pdf$VOLA
  stocks.panel.pdf$VOLE <- stocks.VOLE.pdf$VOLE
  stocks.panel.pdf$VOLP <- stocks.VOLP.pdf$VOLP
  stocks.panel.pdf$TOV <- stocks.TOV.pdf$TOV
  stocks.panel.pdf$TOVMA <- stocks.TOVMA.pdf$TOVMA
  stocks.panel.pdf$LIQ <- stocks.LIQ.pdf$LIQ
  stocks.panel.pdf$VOL <- stocks.VOL.pdf$VOL
  stocks.panel.pdf$SIZE <- stocks.SIZE.pdf$SIZE
  stocks.panel.pdf$FLT <- stocks.FLT.pdf$FLT
  stocks.panel.pdf$PR <- 1/stocks.PR.pdf$PR
  stocks.panel.pdf$PRL <- log(stocks.PR.pdf$PR)
  stocks.panel.pdf$EEU <- stocks.EEU.pdf$EEU
  stocks.panel.pdf$EED <- stocks.EED.pdf$EED
  stocks.panel.pdf$EEUlag <- stocks.EEUL.pdf$EEUL
  stocks.panel.pdf$EEDlag <- stocks.EEDL.pdf$EEDL
  stocks.panel.pdf$EEMU <- stocks.EEMU.pdf$EEMU
  stocks.panel.pdf$EEMD <- stocks.EEMD.pdf$EEMD
  stocks.panel.pdf$EEMUlag <- stocks.EEMUL.pdf$EEMUL
  stocks.panel.pdf$EEMDlag <- stocks.EEMDL.pdf$EEMDL
  stocks.panel.pdf$REVU <- stocks.REVU.pdf$REVU
  stocks.panel.pdf$REVD <- stocks.REVD.pdf$REVD
  stocks.panel.pdf$HFLU0 <- stocks.HFLU0.pdf$HFLU0
  stocks.panel.pdf$HFLD0 <- stocks.HFLD0.pdf$HFLD0
  stocks.panel.pdf$HFLU1 <- stocks.HFLU1.pdf$HFLU1
  stocks.panel.pdf$HFLD1 <- stocks.HFLD1.pdf$HFLD1
  stocks.panel.pdf$HFLU5 <- stocks.HFLU5.pdf$HFLU5
  stocks.panel.pdf$HFLD5 <- stocks.HFLD5.pdf$HFLD5
  stocks.panel.pdf$HFLU15 <- stocks.HFLU15.pdf$HFLU15
  stocks.panel.pdf$HFLD15 <- stocks.HFLD15.pdf$HFLD15
  stocks.panel.pdf$VOLU0 <- stocks.VOLU0.pdf$VOLU0
  stocks.panel.pdf$VOLD0 <- stocks.VOLD0.pdf$VOLD0
  stocks.panel.pdf$VOLU1 <- stocks.VOLU1.pdf$VOLU1
  stocks.panel.pdf$VOLD1 <- stocks.VOLD1.pdf$VOLD1
  stocks.panel.pdf$VOLU5 <- stocks.VOLU5.pdf$VOLU5
  stocks.panel.pdf$VOLD5 <- stocks.VOLD5.pdf$VOLD5
  stocks.panel.pdf$VOLU15 <- stocks.VOLU15.pdf$VOLU15
  stocks.panel.pdf$VOLD15 <- stocks.VOLD15.pdf$VOLD15
#   stocks.panel.pdf$RVOLU0 <- stocks.RVOLU0.pdf$RVOLU0
#   stocks.panel.pdf$RVOLD0 <- stocks.RVOLD0.pdf$RVOLD0
#   stocks.panel.pdf$RVOLU1 <- stocks.RVOLU1.pdf$RVOLU1
#   stocks.panel.pdf$RVOLD1 <- stocks.RVOLD1.pdf$RVOLD1
#   stocks.panel.pdf$RVOLU5 <- stocks.RVOLU5.pdf$RVOLU5
#   stocks.panel.pdf$RVOLD5 <- stocks.RVOLD5.pdf$RVOLD5
#   stocks.panel.pdf$RVOLU15 <- stocks.RVOLU15.pdf$RVOLU15
#   stocks.panel.pdf$RVOLD15 <- stocks.RVOLD15.pdf$RVOLD15
  stocks.panel.pdf$HFLVU0 <- ifelse (stocks.VOLU0.pdf$VOLU0 > 0,
    1000000 * stocks.HFLU0.pdf$HFLU0 / stocks.VOLU0.pdf$VOLU0, stocks.HFLU0.pdf$HFLU0)
  stocks.panel.pdf$HFLVD0 <- ifelse (stocks.VOLD0.pdf$VOLD0 > 0,
    1000000 * stocks.HFLD0.pdf$HFLD0 / stocks.VOLD0.pdf$VOLD0, stocks.HFLD0.pdf$HFLD0)
  stocks.panel.pdf$HFLVU1 <- ifelse (stocks.VOLU1.pdf$VOLU1 > 0,
    1000000 * stocks.HFLU1.pdf$HFLU1 / stocks.VOLU1.pdf$VOLU1, stocks.HFLU1.pdf$HFLU1)
  stocks.panel.pdf$HFLVD1 <- ifelse (stocks.VOLD1.pdf$VOLD1 > 0,
    1000000 * stocks.HFLD1.pdf$HFLD1 / stocks.VOLD1.pdf$VOLD1, stocks.HFLD1.pdf$HFLD1)
  stocks.panel.pdf$HFLVU5 <- ifelse (stocks.VOLU5.pdf$VOLU5 > 0,
    1000000 * stocks.HFLU5.pdf$HFLU5 / stocks.VOLU5.pdf$VOLU5, stocks.HFLU5.pdf$HFLU5)
  stocks.panel.pdf$HFLVD5 <- ifelse (stocks.VOLD5.pdf$VOLD5 > 0,
    1000000 * stocks.HFLD5.pdf$HFLD5 / stocks.VOLD5.pdf$VOLD5, stocks.HFLD5.pdf$HFLD5)
  stocks.panel.pdf$HFLVU15 <- ifelse (stocks.VOLU15.pdf$VOLU15 > 0,
    1000000 * stocks.HFLU15.pdf$HFLU15 / stocks.VOLU15.pdf$VOLU15, stocks.HFLU15.pdf$HFLU15)
  stocks.panel.pdf$HFLVD15 <- ifelse (stocks.VOLD15.pdf$VOLD15 > 0,
    1000000 * stocks.HFLD15.pdf$HFLD15 / stocks.VOLD15.pdf$VOLD15, stocks.HFLD15.pdf$HFLD15)
  stocks.panel.pdf$HFLLU0 <- stocks.panel.pdf$HFLVU0 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLD0 <- stocks.panel.pdf$HFLVD0 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLU1 <- stocks.panel.pdf$HFLVU1 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLD1 <- stocks.panel.pdf$HFLVD1 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLU5 <- stocks.panel.pdf$HFLVU5 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLD5 <- stocks.panel.pdf$HFLVD5 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLU15 <- stocks.panel.pdf$HFLVU15 * stocks.panel.pdf$PR * 10
  stocks.panel.pdf$HFLLD15 <- stocks.panel.pdf$HFLVD15 * stocks.panel.pdf$PR * 10
  
#   stocks.panel.pdf$IEM <- stocks.IEM.pdf$IEM * 100
#   stocks.panel.pdf$IEMD <- stocks.IEMD.pdf$IEMD * 100
#   stocks.panel.pdf$IEQ95 <- stocks.IEQ95.pdf$IEQ95 * 100
#   stocks.panel.pdf$IEQ99 <- stocks.IEQ99.pdf$IEQ99 * 100
#   stocks.panel.pdf$IET <- stocks.IET.pdf$IET
#   stocks.panel.pdf$IRM <- stocks.IRM.pdf$IRM * 100
#   stocks.panel.pdf$IRQ95 <- stocks.IRQ95.pdf$IRQ95 * 100
#   stocks.panel.pdf$IRQ99 <- stocks.IRQ99.pdf$IRQ99 * 100
#   stocks.panel.pdf$IRT <- stocks.IRT.pdf$IRT
#   stocks.panel.pdf$IRT5 <- stocks.IRT5.pdf$IRT5
#   stocks.panel.pdf$IRT15 <- stocks.IRT15.pdf$IRT15
#   stocks.panel.pdf$IRK <- stocks.IRK.pdf$IRK
#   stocks.panel.pdf$IRK5 <- stocks.IRK5.pdf$IRK5
#   stocks.panel.pdf$IRK15 <- stocks.IRK15.pdf$IRK15
#   stocks.panel.pdf$IRMA <- stocks.IRMA.pdf$IRMA * 100
#   stocks.panel.pdf$IRMDA <- stocks.IRMDA.pdf$IRMDA * 100
#   stocks.panel.pdf$IRS <- stocks.IRS.pdf$IRS * 100
#   stocks.panel.pdf$IRS5 <- stocks.IRS5.pdf$IRS5 * 100
#   stocks.panel.pdf$IRS15 <- stocks.IRS15.pdf$IRS15 * 100
#   stocks.panel.pdf$IRMIN <- stocks.IRMIN.pdf$IRMIN * 100
#   stocks.panel.pdf$IRMAX <- stocks.IRMAX.pdf$IRMAX * 100
  
  # variables that should not be Winsorized
  stocks.panel.pdf$NMS <- stocks.NMS.pdf$NMS
  stocks.panel.pdf$SSB <- stocks.SSB.pdf$SSB
  stocks.panel.pdf$NAB <- sapply(1:nrow(stocks.panel.pdf), function(x)
    as.Date(stocks.panel.pdf$date[x]) >= ("2011-11-30"))
  stocks.panel.pdf$EEUT30 <- as.ordered(round(stocks.EEUT.pdf$EEUT/30))
  stocks.panel.pdf$EEDT30 <- as.ordered(round(stocks.EEDT.pdf$EEDT/30))
  stocks.panel.pdf$EEUT15 <- as.ordered(round(stocks.EEUT.pdf$EEUT/15))
  stocks.panel.pdf$EEDT15 <- as.ordered(round(stocks.EEDT.pdf$EEDT/15))
  stocks.panel.pdf$DTU <- interaction(stocks.panel.pdf$date, stocks.panel.pdf$EEUT30)
  stocks.panel.pdf$DTD <- interaction(stocks.panel.pdf$date, stocks.panel.pdf$EEDT30)
  stocks.panel.pdf$TREND <- as.integer(stocks.panel.pdf$date)
  
  return (stocks.panel.pdf)
}

stocks.panel.pdf <- ConstructPanel (off = T)
names(stocks.panel.pdf)
# remove erroneous variables
stocks.panel.pdf <- stocks.panel.pdf[ , -which(names(stocks.panel.pdf) %in% c("SSB"))]
# stocks.panel.pdf <- stocks.panel.pdf[ , -which(names(stocks.panel.pdf) %in% c("NMS"))]
stocks.panel.pdf <- stocks.panel.pdf[ , -which(names(stocks.panel.pdf) %in% c("NAB"))]

# 3.2b) Manual Adjustments of PDF ----------------------------------------------
# adjust erroneous symbols
# TOV
agg <- aggregate(stocks.panel.pdf$TOV, by=list(stocks.panel.pdf$symbol), mean)
plot(agg)
names(agg) <- c("symbol", "tov.avg")
head(agg)
agg$symbol[agg$tov.avg > 0.2]

stocks.panel.pdf$TOV[stocks.panel.pdf$symbol %in% 
                       agg$symbol[agg$tov.avg > 0.2]] <-
  stocks.panel.pdf$TOV[stocks.panel.pdf$symbol %in% 
                         agg$symbol[agg$tov.avg > 0.2]] / 10
# TOV, 2nd round
agg <- aggregate(stocks.panel.pdf$TOV, by=list(stocks.panel.pdf$symbol), mean)
plot(agg)
names(agg) <- c("symbol", "tov.avg")
head(agg)
agg$symbol[agg$tov.avg > 0.1]

stocks.panel.pdf$TOV[stocks.panel.pdf$symbol %in% 
                       agg$symbol[agg$tov.avg > 0.1]] <-
  stocks.panel.pdf$TOV[stocks.panel.pdf$symbol %in% 
                         agg$symbol[agg$tov.avg > 0.1]] / 2

stocks.panel.pdf$TOV[stocks.panel.pdf$symbol %in% 
                       agg$symbol[agg$tov.avg > 0.05]] <-
  stocks.panel.pdf$TOV[stocks.panel.pdf$symbol %in% 
                         agg$symbol[agg$tov.avg > 0.05]] / 2


# check TOV adjustments
agg <- aggregate(stocks.panel.pdf$TOV, by=list(stocks.panel.pdf$symbol), mean)
plot(agg)
rm(agg)

# SIZE
agg <- aggregate(stocks.panel.pdf$SIZE, by=list(stocks.panel.pdf$symbol), mean)
plot(agg)
names(agg) <- c("symbol", "size.avg")
head(agg)
agg$symbol[agg$size.avg > 12.75]

# adjust for massive capital structure changes during financial crisis
stocks.panel.pdf$SIZE[stocks.panel.pdf$symbol %in% 
                       c("AIG.N", "C.N", "IRE.N")] <-
  stocks.panel.pdf$SIZE[stocks.panel.pdf$symbol %in% 
                          c("AIG.N", "C.N", "IRE.N")] - log(10)
stocks.panel.pdf$SIZE[stocks.panel.pdf$symbol %in% 
                        c("ABV.N", "BAC.N")] <-
  stocks.panel.pdf$SIZE[stocks.panel.pdf$symbol %in% 
                          c("ABV.N", "BAC.N")] - log(5)
# check SIZE adjustments
agg <- aggregate(stocks.panel.pdf$SIZE, by=list(stocks.panel.pdf$symbol), mean)
plot(agg)
# apply adjustments to float
stocks.panel.pdf$FLT[stocks.panel.pdf$symbol %in% 
                        c("AIG.N", "C.N", "IRE.N")] <-
  stocks.panel.pdf$FLT[stocks.panel.pdf$symbol %in% 
                          c("AIG.N", "C.N", "IRE.N")] - log(10*.9)
stocks.panel.pdf$FLT[stocks.panel.pdf$symbol %in% 
                        c("ABV.N", "BAC.N")] <-
  stocks.panel.pdf$FLT[stocks.panel.pdf$symbol %in% 
                          c("ABV.N", "BAC.N")] - log(5*.9)

rm(agg)

# 3.2c) check bivariate distributions to identify outlier/erroneous data ---------
# stock.sel <- levels(stocks.panel.pdf$symbol)[round(runif(66)*length(levels(stocks.panel.pdf$symbol)))]
# with(stocks.panel.pdf[stocks.panel.pdf$symbol %in% stock.sel,],{
#   # scatterplotMatrix(cbind(HFL, HPQ, HPF, HPQL, HPFL))
#   scatterplotMatrix(cbind(log(HFL+1), PR, SIZE, log(TOV), log(VOLE)))
# 
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_1.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), HPQ, HPF, HPQL, HPFL))
# #   dev.off()
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_2.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), VOLE, TOV, SIZE, PR))
# #   dev.off()
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_3.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), VOLA, BETA, LIQ, VOL))
# #   dev.off()
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_4.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), FLT, PRL, EEU, EED))
# #   dev.off()
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_5.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), log(IEM), log(IEMD+0.01), log(IEQ99), log(IET+0.00001)))
# #   dev.off()
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_6.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), IRM, IRMDA, IRQ99, IRT))
# #   dev.off()
# #   png(paste(data.path.graph, "ScatMatrix_HFLlog_7.png", sep=""), 
# #       height=1024, width=1440, res=144)
# #   scatterplotMatrix(cbind(log1p(HFL), IRK, IRS, IRMIN, IRMAX))
# #   dev.off()
# })

# # check VIFs
# with(stocks.panel.pdf[stocks.panel.pdf$symbol %in% stock.sel,],{
#   Vif(cbind(log1p(HFL), VOLE, TOV, SIZE, log(PR), BETA), thresh=10, trace=T)
# })
# with(stocks.panel.pdf[stocks.panel.pdf$symbol %in% stock.sel,],{
#   Vif(cbind(HFL, IEMD, IET, IRQ99, IRK, IRMDA, IRS), thresh=10, trace=T)
# })

# 3.2d) Winsorization & Distribution Check ---------------------------------------
# --> RERUN 3.2c) bivariate distribution check to validate result

# Winsorization
names(stocks.panel.pdf)
for (i in c(3:72)) { #3:18, 3:99
  print(paste("Winsorizing var", i, "of", ncol(stocks.panel.pdf)))
  # limit variable cross-section per day
  for(d in seq_along(levels(stocks.panel.pdf$date))) {
    cur.d <- levels(stocks.panel.pdf$date)[d]
    sel <- stocks.panel.pdf$date == cur.d
    stocks.panel.pdf[sel, i] <- Winsor(stocks.panel.pdf[sel, i], 0.0005)
  }
#   # limit variable per stock (only on unconstrained sample)
#   for(s in seq_along(levels(stocks.panel.pdf$symbol))) {
#     cur.s <- levels(stocks.panel.pdf$symbol)[s]
#     sel <- stocks.panel.pdf$symbol == cur.s
#     stocks.panel.pdf[sel, i] <- Winsor (stocks.panel.pdf[sel, i], 0.0005)
#   }
  # limit whole variable for all stock-days
  stocks.panel.pdf[, i] <- Winsor (stocks.panel.pdf[, i], 0.0005)
}
tail(stocks.panel.pdf)

hist(stocks.panel.pdf$HFL)
hist(stocks.panel.pdf$HFLlag)
hist(stocks.panel.pdf$HFLlog)
hist(stocks.panel.pdf$HFLlola)
hist(stocks.panel.pdf$HFLV)
hist(stocks.panel.pdf$HFLVlog)
hist(stocks.panel.pdf$HFLVlola)
hist(stocks.panel.pdf$HFLL)
hist(stocks.panel.pdf$HFLLlog)
hist(stocks.panel.pdf$HFLLlola)
hist(stocks.panel.pdf$HPQV)
hist(stocks.panel.pdf$HPQVlog)
hist(stocks.panel.pdf$HPQL)
hist(stocks.panel.pdf$HPQLlog)
hist(sqrt(stocks.panel.pdf$TOV))
hist(sqrt(stocks.panel.pdf$EEU))
hist((stocks.panel.pdf$REVU))


# 4) Build Panel Models --------------------------------------------------------

# construct exchange & industry dummies
tmp.vec <- (SubstrRight(as.character(stocks.panel.pdf$symbol), 1))
tmp.vec [tmp.vec == "A"] <- "N"
stocks.panel.pdf$EXCHG <- as.factor(tmp.vec)
rm(tmp.vec)

# stocks.panel.pdf$IND <- as.factor(symbol.info[stocks.panel.pdf$symbol[], "Industry"])
# stocks.panel.pdf$SEC <- as.factor(symbol.info[stocks.panel.pdf$symbol[], "Sector"])

VIX <- getYahooData("^VIX")
stocks.panel.pdf$VIX <- coredata(VIX$Close[stocks.panel.pdf$date[]])
rm(VIX)

channel.AB <- stocks.panel.pdf$EXCHG == "Q" & (
              substr(stocks.panel.pdf$symbol, 1,1) == "A" | 
                substr(stocks.panel.pdf$symbol, 1,1) == "B" )
stocks.panel.pdf$QCH <- ifelse(as.Date(stocks.panel.pdf$date) < "2011-10-10", F,
                          ifelse(as.Date(stocks.panel.pdf$date) >= "2011-10-17", T,
                          channel.AB ))
rm(channel.AB)

plot(tapply(stocks.panel.pdf$QCH, stocks.panel.pdf$date, mean))
stocks.panel.sub <- stocks.panel.pdf[stocks.panel.pdf$EXCHG == "Q",]

# 4.1) Model Specification Check: check residual distributions -----------------
# 1st step: HFL

check.res <- felm((HFLlog)~(NMS)+(VOLE)+(SIZE)+(PR)+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
# new felm syntax
check.res <- felm((HFLlog)~(NMS)+(VOLE)+(SIZE)+(PR)+(TOV) | date + symbol | 0 | 
                  date + symbol, stocks.panel.pdf)
summary(check.res)
qqPlot(check.res$residuals, main="HFL log")
HFL.hat <- check.res$fitted

# check autocorrelation of residuals
PanelResAC(check.res, stocks.panel.pdf, "symbol", "date")
class(check.res) <- "lm"
dwtest(check.res, order.by=(stocks.panel.pdf$symbol), "t")
bgtest(check.res, order=1, order.by=(stocks.panel.pdf$symbol))


# 1st step: HFLV
check.res <- felm(HFLVlog~NMS+(VOLE)+SIZE+(PR)+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
check.res <- felm(HFLVlog~NMS+(VOLE)+SIZE+(PR)+(TOV)| date + symbol | 0 | 
                  date + symbol, stocks.panel.pdf)
summary(check.res)

qqPlot(check.res$residuals, main="HFLV log")
HFLV.hat <- check.res$fitted
# perform weak-instruments check (wald-test)
check.res2 <- felm(HFLVlog~(VOLE)+SIZE+(PR)+(TOV)| date + symbol | 0 | 
                    date + symbol, stocks.panel.pdf)
summary(check.res2)
waldtest(check.res2, check.res, test="F")


# 1st step: HFLL
check.res <- felm(HFLLlog~NMS+(VOLE)+SIZE+(PR)+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="HFLL log")
HFLL.hat <- check.res$fitted
# 1st step: HPQV
check.res <- felm(HPQVlog~NMS+(VOLE)+SIZE+(PR)+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="HPQV log")
HPQV.hat <- check.res$fitted
# 1st step: HPQL
check.res <- felm(HPQLlog~NMS+(VOLE)+SIZE+(PR)+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="HPQL log")
HPQL.hat <- check.res$fitted

# 2nd step: HFL -- EEU, EED & EEU+EED
check.res <- felm((EEU)~HFL.hat+VOLE+SIZE+(PR)+(TOVMA)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="EEU ~ HFL")

check.res <- felm(sqrt(EED)~HFL.hat+(VOLE)+SIZE+PR+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="EED ~ HFL")
check.res <- felm(sqrt(EEU+EED)~HFL.hat+(VOLE)+SIZE+PR+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="EEU+EED ~ HFL")

# 2nd step: HFLV -- EEU, EED & EEU+EED
check.res <- felm(sqrt(EEU)~sqrt(EEUlag)+HFLV.hat+(VOLE)+SIZE+(PR)+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="EEU ~ HFLV")

check.res <- felm(sqrt(EED)~sqrt(EEUlag)+HFLV.hat+(VOLE)+SIZE+PR+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="EED ~ HFLV")
check.res <- felm(sqrt(EEU+EED)~HFLV.hat+(VOLE)+SIZE+PR+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="EEU+EED ~ HFLV")


# ...using contemporaneous variables
# 1st step: HFLVU
hist(as.integer(stocks.panel.pdf$EEUT30))
hist(log1p(stocks.panel.pdf$HFLVU15))
check.res <- felm(log1p(HFLVU15)~NMS+(VOLE)+SIZE+PR+(TOV)+G(EEUT30)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="HFLVU5")
HFLVU15.hat <- check.res$fitted

# 1st step: HFLVD
hist(as.integer(stocks.panel.pdf$EEDT30))
hist(log1p(stocks.panel.pdf$HFLVD15))
check.res <- felm(log1p(HFLVD15)~NMS+(VOLE)+SIZE+PR+(TOV)+G(EEDT30)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)
qqPlot(check.res$residuals, main="HFLVD5")
HFLVD15.hat <- check.res$fitted

# 2nd step: EEU ~ HFLVU^
check.res <- felm(sqrt(EEU)~sqrt(EEUlag)+HFLVU15.hat+(VOLE)+SIZE+PR+(TOV)+G(EEUT30)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)

# 2nd step: EED ~ HFLVD^
check.res <- felm(sqrt(EED)~sqrt(EEDlag)+HFLVD15.hat+(VOLE)+SIZE+PR+(TOV)+G(EEDT30)+G(date)+G(symbol), 
                  stocks.panel.pdf, clustervar=interaction(stocks.panel.pdf$symbol, 
                                                           stocks.panel.pdf$date))
summary(check.res)

# 4.2) Check Auto-Correlation
hist(tapply(stocks.panel.pdf$EEU + stocks.panel.pdf$EED, stocks.panel.pdf$symbol, 
   function(x) acf(diff(x), lag.max=1, plot=F)$acf[2,1,1]))
hist(tapply(stocks.panel.pdf$EEU + stocks.panel.pdf$EED, stocks.panel.pdf$symbol, 
            function(x) acf(diff(x), lag.max=1, plot=F)$acf[2,1,1]))

# 4.2) Construct Ranking Factors ------------------------------------------------
# construct SIZE/LIQ/VOLA X-tile factors based on stock-averages in sample
# Factor: SIZE
rank.by <- tapply(stocks.panel.pdf$SIZE, stocks.panel.pdf$symbol, mean)
ranks <- rank(rank.by)/length(rank.by)
rank.cl <- cut(ranks, breaks=c(0, 1/3, 2/3, 1), 
               labels=c("L", "M", "H"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- rownames(rank.by)
classes.size3 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                   levels=c("H", "M", "L"), ordered=T)

rank.cl <- cut(ranks, breaks=c(0, 1/5, 2/5, 3/5, 4/5, 1), 
               labels=c("Q5", "Q4", "Q3", "Q2", "Q1"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.size5 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                        levels=c("Q1", "Q2", "Q3", "Q4", "Q5"), ordered=T)

# Factor: LIQ
rank.by <- tapply(stocks.panel.pdf$LIQ, stocks.panel.pdf$symbol, mean)
ranks <- rank(rank.by)/length(rank.by)
rank.cl <- cut(ranks, breaks=c(0, 1/3, 2/3, 1), 
               labels=c("L", "M", "H"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.liq3 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                        levels=c("H", "M", "L"), ordered=T)

rank.cl <- cut(ranks, breaks=c(0, 1/5, 2/5, 3/5, 4/5, 1), 
               labels=c("Q5", "Q4", "Q3", "Q2", "Q1"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.liq5 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                        levels=c("Q1", "Q2", "Q3", "Q4", "Q5"), ordered=T)

# Factor: TOV
rank.by <- tapply(stocks.panel.pdf$TOV, stocks.panel.pdf$symbol, mean)
ranks <- rank(rank.by)/length(rank.by)
rank.cl <- cut(ranks, breaks=c(0, 1/3, 2/3, 1), 
               labels=c("L", "M", "H"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.tov3 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                       levels=c("H", "M", "L"), ordered=T)

rank.cl <- cut(ranks, breaks=c(0, 1/5, 2/5, 3/5, 4/5, 1), 
               labels=c("Q5", "Q4", "Q3", "Q2", "Q1"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.tov5 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                       levels=c("Q1", "Q2", "Q3", "Q4", "Q5"), ordered=T)

# Factor: VOLA
rank.by <- tapply(stocks.panel.pdf$VOLA, stocks.panel.pdf$symbol, mean)
ranks <- rank(rank.by)/length(rank.by)
rank.cl <- cut(ranks, breaks=c(0, 1/3, 2/3, 1), 
               labels=c("L", "M", "H"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.vola3 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                       levels=c("H", "M", "L"), ordered=T)

rank.cl <- cut(ranks, breaks=c(0, 1/5, 2/5, 3/5, 4/5, 1), 
               labels=c("Q5", "Q4", "Q3", "Q2", "Q1"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.vola5 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                       levels=c("Q1", "Q2", "Q3", "Q4", "Q5"), ordered=T)

# Factor: PR
rank.by <- tapply(1/stocks.panel.pdf$PR, stocks.panel.pdf$symbol, mean)
ranks <- rank(rank.by)/length(rank.by)
rank.cl <- cut(ranks, breaks=c(0, 1/3, 2/3, 1), 
               labels=c("L", "M", "H"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.price3 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                        levels=c("H", "M", "L"), ordered=T)

rank.cl <- cut(ranks, breaks=c(0, 1/5, 2/5, 3/5, 4/5, 1), 
               labels=c("Q5", "Q4", "Q3", "Q2", "Q1"), include.lowest=TRUE)
rank.cl <- as.matrix(rank.cl)
rownames(rank.cl) <- levels(stocks.panel.pdf$symbol)
classes.price5 <- factor(rank.cl[stocks.panel.pdf$symbol,], 
                        levels=c("Q1", "Q2", "Q3", "Q4", "Q5"), ordered=T)

rm(rank.by)
rm(ranks)
rm(rank.cl)

# WORKSPACE INCLUDES PANEL PREPS UNTIL HERE ------------------------------------
# 4.3) Check instrument --------------------------------------------------------
names(stocks.panel.pdf)
# 4.3a) Check instrument vs. HFTx
# NMS
Reg1stStage(stocks.panel.pdf, formula(HFL~NMS | date+symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HFLlog~NMS | date+symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HFLVlog~NMS | date+symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HFLLlog~NMS | date+symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HPQVlog~NMS | date+symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HPQLlog~NMS | date+symbol | 0 | date+symbol), 
            classes.size3, T, F)
# NAB
Reg1stStage(stocks.panel.pdf, formula(HFL~NAB+TREND | symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HFLlog~NAB+TREND | symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HFLVlog~NAB+TREND | symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HFLLlog~NAB+TREND | symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HPQVlog~NAB+TREND | symbol | 0 | date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(HPQLlog~NAB+TREND | symbol | 0 | date+symbol), 
            classes.size3, T, F)


with(stocks.panel.pdf[1:(nrow(stocks.panel.pdf)/10),],  
  scatterplot((VOLE), sqrt(EEU)))

with(stocks.panel.pdf[1:(nrow(stocks.panel.pdf)/10),],  
     scatterplot(log(TOV), log(EEU)))

with(stocks.panel.pdf[(1:(nrow(stocks.panel.pdf)/10))*10,],  
     scatterplot(PRL, log(EEU)))

with(stocks.panel.pdf[(1:(nrow(stocks.panel.pdf)/10))*10,],  
     scatterplot(log(VOLE), log(EEU+EED)))

with(stocks.panel.pdf[(1:(nrow(stocks.panel.pdf)/10))*10,],  
     scatterplot((SIZE), log(EEU+EED)))

with(stocks.panel.pdf[1:(nrow(stocks.panel.pdf)/10),],  
     scatterplot(HFLLlog, (log(EEU+EED))))

# 4.3b) Check instrument vs. Controls
# NMS
Reg1stStage(stocks.panel.pdf, formula((VOLE)~NMS|date+symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$VOLE))
Reg1stStage(stocks.panel.pdf, formula((TOV)~NMS|date+symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$TOV))
Reg1stStage(stocks.panel.pdf, formula((SIZE)~NMS|date+symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$SIZE))
Reg1stStage(stocks.panel.pdf, formula((PR)~NMS|date+symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$PR))

# NAB
Reg1stStage(stocks.panel.pdf, formula((VOLE)~NAB+TREND|symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$VOLE))
Reg1stStage(stocks.panel.pdf, formula((TOV)~NAB+TREND|symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$TOV))
Reg1stStage(stocks.panel.pdf, formula((SIZE)~NAB+TREND|symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$SIZE))
Reg1stStage(stocks.panel.pdf, formula((PR)~NAB+TREND|symbol|0|date+symbol), 
            classes.size3, T, F)
summary((stocks.panel.pdf$PR))


# 4.3c) Check instrument vs. Dependent EEU/EED
Reg1stStage(stocks.panel.pdf, formula(sqrt(EEU)~NMS|date+symbol|0|date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(sqrt(EED)~NMS|date+symbol|0|date+symbol),
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(sqrt(EEU+EED)~NMS|date+symbol|0|date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(sqrt(EEU)~NMS+(VOLE)+PR+SIZE+(TOV)|date+symbol|0|date+symbol), 
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(sqrt(EED)~NMS+(VOLE)+PR+SIZE+(TOV)|date+symbol|0|date+symbol),
            classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(sqrt(EEU+EED)~NMS+VOLE+PR+SIZE+(TOV)|date+symbol|0|date+symbol), 
            classes.size3, T, F)

Reg1stStage(stocks.panel.pdf, formula((IEM)~NMS+G(date)+G(symbol)), classes.size3)
Reg1stStage(stocks.panel.pdf, formula((IEQ95)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IEQ99)~NMS+G(date)+G(symbol)), classes.size3, T, T)
Reg1stStage(stocks.panel.pdf, formula((IET)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRM)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRQ95)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRQ99)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(log(IRT)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(log(IRT5)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(log(IRT15)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(log(IRK)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(log(IRK5)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula(log(IRK15)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRMA)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRS)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRS5)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRS15)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRMIN)~NMS+G(date)+G(symbol)), classes.size3, T, F)
Reg1stStage(stocks.panel.pdf, formula((IRMAX)~NMS+G(date)+G(symbol)), classes.size3, T, F)

str(stocks.panel.pdf)

# 4.4) Perform 2SLS IVREG ------------------------------------------------------

# "IEM"     "IEMD"    "IEQ95"  
# "IEQ99"   "IET"     "IRM"     "IRQ95"   "IRQ99"   "IRT"     "IRK"    
# "IRMA"    "IRMDA"   "IRS"     "IRMIN"   "IRMAX" 
# 
# WIF-CHECKED: IEMD, IET, IRQ99, IRK, IRMDA, IRS

qqPlot(HFL.res2$residuals)
# 4.4a) HFL IVREG
suffix <- "HFLlog"
HFL.res2 <- felm (sqrt(EEU+EED)~HFLlog+(VOLE)+PR+SIZE+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLlog~NMS, 
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
# Option 1 to reconstruct result
HFL.res2 <- felm (formula(sqrt(EEU+EED)~(VOLE)+PR+SIZE+(TOV)|date+symbol|
                    (HFLlog~NMS)), stocks.panel.pdf, 
                  clustervar=interaction(stocks.panel.pdf$date, 
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)
# Option 2 to reconstruct result
HFL.res2 <- felm (formula(sqrt(EEU+EED)~(VOLE)+PR+SIZE+(TOV)|date+symbol|
                            (HFLlog~NMS)), stocks.panel.pdf)
summary(HFL.res2, robust=TRUE)


# 4.4b) HFLV IVREG
HFLV.res2 <- felm (sqrt(EEU+EED)~HFLVlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVlog~NMS, 
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFLV.res2)
# Option 2 to reconstruct result
HFL.res2 <- felm (formula(sqrt(EEU+EED)~(VOLE)+PR+SIZE+(TOV)|date+symbol|
                            (HFLVlog~NMS)), stocks.panel.pdf)
summary(HFL.res2, robust=TRUE)

HFL.res2 <- felm (formula((REVU+REVD)~(VOLE)+PR+SIZE+(TOV)|date+symbol|
                            (HFLVlog~NMS)), stocks.panel.pdf)
summary(HFL.res2, robust=T)




# 4.4c) HFLL IVREG
HFLL.res2 <- felm (sqrt(EEU+EED)~HFLLlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.pdf, iv=HFLLlog~NMS, 
                   clustervar=interaction(stocks.panel.pdf$date,
                                          stocks.panel.pdf$symbol))
summary(HFLL.res2)
# 4.4d) HPQV IVREG
HPQV.res2 <- felm (sqrt(EEU+EED)~HPQVlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.pdf, iv=HPQVlog~NMS, 
                   clustervar=interaction(stocks.panel.pdf$date,
                                          stocks.panel.pdf$symbol))
summary(HPQV.res2)
# 4.4e) HPQL IVREG
HPQL.res2 <- felm (sqrt(EEU+EED)~HPQLlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.pdf, iv=HPQLlog~NMS, 
                   clustervar=interaction(stocks.panel.pdf$date,
                                          stocks.panel.pdf$symbol))
summary(HPQL.res2)

# 4.4f) CONTEMPORANEOUS IVREG
names(stocks.panel.pdf)
hist(log1p(stocks.panel.pdf$HFLVU15))
hist(log1p(stocks.panel.pdf$HFLVD15))
stocks.panel.pdf$HFLVU15log <- log1p(stocks.panel.pdf$HFLVU15)
stocks.panel.pdf$HFLVD15log <- log1p(stocks.panel.pdf$HFLVD15)
stocks.panel.pdf$HFLVU5log <- log1p(stocks.panel.pdf$HFLVU5)
stocks.panel.pdf$HFLVD5log <- log1p(stocks.panel.pdf$HFLVD5)
stocks.panel.pdf$RVOLU15[is.na(stocks.panel.pdf$RVOLU15)] <- 1
stocks.panel.pdf$RVOLD15[is.na(stocks.panel.pdf$RVOLD15)] <- 1
stocks.panel.pdf$RVOLU5[is.na(stocks.panel.pdf$RVOLU5)] <- 1
stocks.panel.pdf$RVOLD5[is.na(stocks.panel.pdf$RVOLD5)] <- 1

suffix <- "HFLVU15log"
HFL.res2 <- felm (sqrt(EEU)~HFLVU15log+VOLE+PR+SIZE+(TOV)+G(EEUT15)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVU15log~NMS, exactDOF=T,
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)

HFL.res2 <- felm (REVUF~HFLVU15log+(VOLE)+PR+SIZE+(TOV)+G(EEUT15)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVU15log~NMS, exactDOF=T,
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)


suffix <- "HFLVD15log"
HFL.res2 <- felm (sqrt(EED)~HFLVD15log+(VOLE)+PR+SIZE+(TOV)+G(EEDT15)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVD15log~NMS, exactDOF=T,
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)

suffix <- "HFLVD15log"
HFL.res2 <- felm (REVDF~HFLVD15log+(VOLE)+PR+SIZE+(TOV)+G(EEDT15)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVD15log~NMS, exactDOF=T,
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)


suffix <- "HFLVU5log"
HFL.res2 <- felm (sqrt(EEU)~HFLVU5log+(VOLE)+PR+SIZE+(TOV)+G(EEUT15)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVU5log~NMS, exactDOF=T,
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)

suffix <- "HFLVD5log"
HFL.res2 <- felm (sqrt(EED)~HFLVD5log+(VOLE)+PR+SIZE+(TOV)+G(EEDT15)+G(date)+G(symbol), 
                  stocks.panel.pdf, iv=HFLVD5log~NMS, exactDOF=T,
                  clustervar=interaction(stocks.panel.pdf$date,
                                         stocks.panel.pdf$symbol))
summary(HFL.res2)


# 4.5) SPECIAL -- 2SLS EXCEL - NMS ---------------------------------------------

export.XL <- F
step.1 <- T

# 4.5a) HFLlog
reg2.f <- formula (sqrt(EEU+EED) ~ HFLlog + (VOLE) + PR + SIZE + (TOV) +
                     G(date) + G(symbol))
reg1.f <- formula (HFLlog ~ NMS + (VOLE) + PR + SIZE + (TOV) +
                     G(date) + G(symbol))
reg1b.f <- formula (HFLlog ~ (VOLE) + PR + SIZE + (TOV) +
                      G(date) + G(symbol))
iv.f <- formula (HFLlog ~ NMS)

varname="HFLlog"
# run
source("R/IVREG.R")
varname="HFLlog2"
reg2.f <- update.formula(reg2.f, (EEU+EED) ~ .)
source("R/IVREG.R")
# varname="HFLlog_UP"
# reg2.f <- update.formula(reg2.f, sqrt(EEU)  ~ .)
# source("R/IVREG.R")
# 
# varname="HFLlog_DN"
# reg2.f <- update.formula(reg2.f, sqrt(EED)  ~ .)
# source("R/IVREG.R")


# 4.5b) HFLVlog
reg2.f <- formula (sqrt(EEU+EED)~ HFLVlog + (VOLE) + PR + SIZE + (TOV) + 
                     G(date) + G(symbol))
reg1.f <- formula (HFLVlog ~ NMS + (VOLE) + PR + SIZE + (TOV) + 
                     G(date) + G(symbol))
reg1b.f <- formula (HFLVlog ~ (VOLE) + PR + SIZE + (TOV) + 
                      G(date) + G(symbol))
iv.f <- HFLVlog ~ NMS
varname="HFLVlog"
# run
source("R/IVREG.R")
varname="HFLVlog2"
reg2.f <- update.formula(reg2.f, (EEU+EED) ~ .)
source("R/IVREG.R")
# varname="HFLVlog_UP"
# reg2.f <- update.formula(reg2.f, sqrt(EEU)  ~ .)
# source("R/IVREG.R")
# varname="HFLVlog_DN"
# reg2.f <- update.formula(reg2.f, sqrt(EED)  ~ .)
# source("R/IVREG.R")

# 4.5c) HFLLlog
reg2.f <- formula (sqrt(EEU + EED) ~ HFLLlog + (VOLE) + PR + SIZE + (TOV) + 
                     G(date) + G(symbol))
reg1.f <- formula (HFLLlog ~ NMS + (VOLE) + PR + SIZE + (TOV) + 
                     G(date) + G(symbol))
reg1b.f <- formula (HFLLlog ~ (VOLE) + PR + SIZE + (TOV) + 
                      G(date) + G(symbol))
iv.f <- HFLLlog ~ NMS
varname="HFLLlog"
# run
source("R/IVREG.R")
varname="HFLLlog2"
reg2.f <- update.formula(reg2.f, (EEU+EED) ~ .)
source("R/IVREG.R")
# varname="HFLLlog_UP"
# reg2.f <- update.formula(reg2.f, sqrt(EEU)  ~ .)
# source("R/IVREG.R")
# varname="HFLLlog_DN"
# reg2.f <- update.formula(reg2.f, sqrt(EED)  ~ .)
# source("R/IVREG.R")

# 4.5d) Contemporaneous HFT
stocks.panel.pdf$HFLVU15log <- log1p(stocks.panel.pdf$HFLVU15)
stocks.panel.pdf$HFLVD15log <- log1p(stocks.panel.pdf$HFLVD15)
stocks.panel.pdf$HFLVU5log <- log1p(stocks.panel.pdf$HFLVU5)
stocks.panel.pdf$HFLVD5log <- log1p(stocks.panel.pdf$HFLVD5)
stocks.panel.pdf$TOVU15 <- (log(stocks.panel.pdf$VOLU15)-stocks.panel.pdf$FLT)
stocks.panel.pdf$TOVD15 <- (log(stocks.panel.pdf$VOLD15)-stocks.panel.pdf$FLT)
stocks.panel.pdf$TOVU15 <- 0.01*exp(stocks.panel.pdf$TOVU15)
stocks.panel.pdf$TOVD15 <- 0.01*exp(stocks.panel.pdf$TOVD15)
summary(stocks.panel.pdf$TOV)
summary(stocks.panel.pdf$TOVU15)

# 4.5d1) HFLVU15log controlled by log TOV
reg2.f <- formula (sqrt(EEU) ~ HFLVU15log + (VOLE) + PR + SIZE + TOVU15 +
                     G(EEUT15) + G(date) + G(symbol))
reg1.f <- formula (HFLVU15log ~ NMS + (VOLE) + PR + SIZE + TOVU15 + G(EEUT15) +
                     G(date) + G(symbol))
reg1b.f <- formula (HFLVU15log ~ (VOLE) + PR + SIZE + TOVU15 + G(EEUT15) +
                      G(date) + G(symbol))
iv.f <- HFLVU15log ~ NMS
varname="HFLVU15log"
# run
source("R/IVREG.R")
varname="HFLVU15log2"
reg2.f <- update.formula(reg2.f, (EEU) ~ .)
source("R/IVREG.R")

# 4.5d2) HFLVD15log controlled by log TOV
reg2.f <- formula (sqrt(EED) ~ HFLVD15log + (VOLE) + PR + SIZE + (TOVD15) + 
                     G(EEDT15) + G(date) + G(symbol))
reg1.f <- formula (HFLVD15log ~ NMS + (VOLE) + PR + SIZE + (TOVD15) + G(EEDT15) +
                     G(date) + G(symbol))
reg1b.f <- formula (HFLVD15log ~ (VOLE) + PR + SIZE + (TOVD15) + G(EEDT15) +
                      G(date) + G(symbol))
iv.f <- HFLVD15log ~ NMS
varname="HFLVD15log"
# run
source("R/IVREG.R")
varname="HFLVD15log2"
reg2.f <- update.formula(reg2.f, (EEU) ~ .)
source("R/IVREG.R")


# # 4.5e) Intraday Tail Index 
# summary(stocks.panel.pdf$IRT)
# stocks.panel.pdf$IRT[is.na(stocks.panel.pdf$IRT)] <- .44
# summary(stocks.panel.pdf$IRT5)
# stocks.panel.pdf$IRT5[is.na(stocks.panel.pdf$IRT5)] <- .4
# summary(stocks.panel.pdf$IRT15)
# stocks.panel.pdf$IRT15[is.na(stocks.panel.pdf$IRT15)] <- .36
# summary(stocks.panel.pdf$IET)
# stocks.panel.pdf$IET[is.na(stocks.panel.pdf$IET)] <- .45
# 
# # HFLVlog
# reg2.f <- formula ( (IRT15) ~ HFLVlog + (VOLE) + PR + SIZE + (TOV) + 
#                      G(date) + G(symbol))
# reg1.f <- formula (HFLVlog ~ NMS + (VOLE) + PR + SIZE + (TOV) + 
#                      G(date) + G(symbol))
# reg1b.f <- formula (HFLVlog ~ (VOLE) + PR + SIZE + (TOV) + 
#                       G(date) + G(symbol))
# iv.f <- HFLVlog ~ NMS
# varname="HFLVlog_IRT15"
# # run
# source("R/IVREG.R")

# 4.6 SPECIAL -- 2SLS EXCEL - NAB ----------------------------------------------

export.XL = T
step.1 <- T
stocks.panel.pdf$DOW <- weekdays(as.Date(stocks.panel.pdf$date))

# 4.6a) HFLlog
reg2.f <- formula (sqrt(EEU + EED) ~ HFLlog + (VOLE) + PR + SIZE + (TOV) + 
                     TREND + G(symbol))
reg1.f <- formula (HFLlog ~ NAB + (VOLE) + PR + SIZE + (TOV) + 
                     TREND + G(symbol))
reg1b.f <- formula (HFLlog ~ (VOLE) + PR + SIZE + (TOV) + 
                      TREND + G(symbol))
iv.f <- HFLlog ~ NAB
varname="HFLlog"
# run
source("R/IVREG.R")
varname="HFLlog2"
reg2.f <- update.formula(reg2.f, (EEU+EED) ~ .)
source("R/IVREG.R")
# varname="HFLlog_UP"
# reg2.f <- update.formula(reg2.f, sqrt(EEU)  ~ .)
# source("R/IVREG.R")
# varname="HFLlog_DN"
# reg2.f <- update.formula(reg2.f, sqrt(EED)  ~ .)
# source("R/IVREG.R")

# 4.6b) HFLVlog
reg2.f <- formula (sqrt(EEU + EED) ~ HFLVlog + (VOLE) + PR + SIZE + (TOV) + 
                     TREND + G(symbol))
reg1.f <- formula (HFLVlog ~ NAB + (VOLE) + PR + SIZE + (TOV) + 
                     TREND + G(symbol))
reg1b.f <- formula (HFLVlog ~ (VOLE) + PR + SIZE + (TOV) + 
                      TREND + G(symbol))
iv.f <- HFLVlog ~ NAB
varname="HFLVlog"
# run
source("R/IVREG.R")
varname="HFLVlog2"
reg2.f <- update.formula(reg2.f, (EEU+EED) ~ .)
source("R/IVREG.R")
# varname="HFLVlog_UP"
# reg2.f <- update.formula(reg2.f, sqrt(EEU)  ~ .)
# source("R/IVREG.R")
# varname="HFLVlog_DN"
# reg2.f <- update.formula(reg2.f, sqrt(EED)  ~ .)
# source("R/IVREG.R")

# 4.6c) HFLLlog
reg2.f <- formula (sqrt(EEU + EED) ~ HFLLlog + (VOLE) + PR + SIZE + (TOV) + 
                     TREND + G(symbol))
reg1.f <- formula (HFLLlog ~ NAB + (VOLE) + PR + SIZE + (TOV) + 
                     TREND + G(symbol))
reg1b.f <- formula (HFLLlog ~ (VOLE) + PR + SIZE + (TOV) + 
                      TREND + G(symbol))
iv.f <- HFLLlog ~ NAB
varname="HFLLlog"
# run
source("R/IVREG.R")
varname="HFLLlog2"
reg2.f <- update.formula(reg2.f, (EEU+EED) ~ .)
source("R/IVREG.R")
# varname="HFLLlog_UP"
# reg2.f <- update.formula(reg2.f, sqrt(EEU)  ~ .)
# source("R/IVREG.R")
# varname="HFLLlog_DN"
# reg2.f <- update.formula(reg2.f, sqrt(EED)  ~ .)
# source("R/IVREG.R")

# 4.6d) Contemporaneous HFT
stocks.panel.pdf$HFLVU15log <- log1p(stocks.panel.pdf$HFLVU15)
stocks.panel.pdf$HFLVD15log <- log1p(stocks.panel.pdf$HFLVD15)
stocks.panel.pdf$HFLVU5log <- log1p(stocks.panel.pdf$HFLVU5)
stocks.panel.pdf$HFLVD5log <- log1p(stocks.panel.pdf$HFLVD5)
stocks.panel.pdf$TOVU15 <- (log(stocks.panel.pdf$VOLU15)-stocks.panel.pdf$FLT)
stocks.panel.pdf$TOVD15 <- (log(stocks.panel.pdf$VOLD15)-stocks.panel.pdf$FLT)
stocks.panel.pdf$TOVU15 <- 0.01*exp(stocks.panel.pdf$TOVU15)
stocks.panel.pdf$TOVD15 <- 0.01*exp(stocks.panel.pdf$TOVD15)

# 4.6d1) HFLVU15log
reg2.f <- formula (sqrt(EEU) ~ HFLVU15log + (VOLE) + PR + SIZE + (TOVU15) + 
                     G(EEUT15) + TREND + G(symbol))
reg1.f <- formula (HFLVU15log ~ NAB + (VOLE) + PR + SIZE + (TOVU15) + G(EEUT15) +
                     TREND + G(symbol))
reg1b.f <- formula (HFLVU15log ~ (VOLE) + PR + SIZE + (TOVU15) + G(EEUT15) +
                      TREND + G(symbol))
iv.f <- HFLVU15log ~ NAB
varname="HFLVU15log"
# run
source("R/IVREG.R")
varname="HFLVU15log2"
reg2.f <- update.formula(reg2.f, (EEU) ~ .)
source("R/IVREG.R")


# 4.6d2) HFLVD15log
reg2.f <- formula (sqrt(EED) ~ HFLVD15log + (VOLE) + PR + SIZE + (TOVD15) + 
                     G(EEDT15) + TREND + G(symbol))
reg1.f <- formula (HFLVD15log ~ NAB + (VOLE) + PR + SIZE + (TOVD15) + G(EEDT15) +
                     TREND + G(symbol))
reg1b.f <- formula (HFLVD15log ~ (VOLE) + PR + SIZE + (TOVD15) + G(EEDT15) +
                      TREND + G(symbol))
iv.f <- HFLVD15log ~ NAB
varname="HFLVD15log"
# run
source("R/IVREG.R")
varname="HFLVD15log2"
reg2.f <- update.formula(reg2.f, (EED) ~ .)
source("R/IVREG.R")

(symbol.info$NMS_Date)

# 4.7) Perform 2SLS IVREG on manually selected subsets -------------------------
# DEFINE SUBSET
subset.vec <- classes.size3 =="H"
stocks.panel.sub <- stocks.panel.pdf[subset.vec,]

# 4.7b) HFLV IVREG SUBSET
HFLV.res2 <- felm (sqrt(EEU+EED)~HFLVlog+sqrt(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.sub, iv=HFLVlog~NMS, exactDOF=T,
                   clustervar=interaction(stocks.panel.sub$date,
                                          stocks.panel.sub$symbol))
summary(HFLV.res2)

# 4.7a) HFL IVREG SUBSET
HFL.res2 <- felm ((EEU+EED)~HFLlog+(VOLE)+PR+SIZE+(TOV)+G(date)+G(symbol), 
                  stocks.panel.sub, iv=HFLlog~NMS, 
                  clustervar=interaction(stocks.panel.sub$date,
                                         stocks.panel.sub$symbol))
summary(HFL.res2)
# 4.7c) HFLL IVREG SUBSET
HFLL.res2 <- felm (sqrt(EEU+EED)~HFLLlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.sub, iv=HFLLlog~NMS, 
                   clustervar=interaction(stocks.panel.sub$date,
                                          stocks.panel.sub$symbol))
summary(HFLL.res2)
# 4.7d) HPQV IVREG SUBSET
HPQV.res2 <- felm (sqrt(EEU+EED)~HPQVlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.sub, iv=HPQVlog~NMS, 
                   clustervar=interaction(stocks.panel.sub$date,
                                          stocks.panel.sub$symbol))
summary(HPQV.res2)
# 4.7e) HPQL IVREG SUBSET
HPQL.res2 <- felm (sqrt(EEU+EED)~HPQLlog+(VOLE)+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.sub, iv=HPQLlog~NMS, 
                   clustervar=interaction(stocks.panel.sub$date,
                                          stocks.panel.sub$symbol))
summary(HPQL.res2)


# 4.8) Perform 2SLS IVREG on for Distributional Properties ---------------------
# 4.8b) HFLV IVREG
names(stocks.panel.pdf)
HFLV.res2 <- felm (VOLE~HFLVlog+VOLP+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.pdf, iv=HFLVlog~NMS, 
                   clustervar=interaction(stocks.panel.pdf$date,
                                          stocks.panel.pdf$symbol))
summary(HFLV.res2)

HFLV.res2 <- felm (IRS~HFLVlog+VOLE+(PR)+SIZE+(TOV)+G(date)+G(symbol), 
                   stocks.panel.pdf, iv=HFLVlog~NMS, 
                   clustervar=interaction(stocks.panel.pdf$date,
                                          stocks.panel.pdf$symbol))
summary(HFLV.res2)


# 4.9) Descriptives of prepared sample -----------------------------------------
# 4.9a) HFT proxies
Summarize2(stocks.panel.pdf$HFL)

# total mean & median
mean(stocks.panel.pdf$HFL)
median(stocks.panel.pdf$HFL)
# total sd within
mean(tapply(stocks.panel.pdf$HFL, 
            as.character(stocks.panel.pdf$symbol),
            function(x) sqrt(sum((x-mean(x))^2)/(length(x)-1)) )) 
# total sd across
sd(tapply(stocks.panel.pdf$HFL, 
          as.character(stocks.panel.pdf$symbol),
          FUN=mean))  

# subgroup mean & median
tapply(stocks.panel.pdf$HFL, interaction(classes.size3),
       FUN=mean)
tapply(stocks.panel.pdf$HFL, interaction(classes.size3),
       FUN=median)
       
# # subgroup sd within & sd across
# for (i in levels(classes.size3)) {
#   print(i)
#   stocks.panel.sub <- stocks.panel.pdf[classes.size3==i,]
#   print("SD within")
#   print(
#     mean(tapply(stocks.panel.sub$HFL, 
#                 as.character(stocks.panel.sub$symbol),
#                 function(x) sqrt(sum((x-mean(x))^2)/(length(x)-1)) )) )
#   print("SD across")
#   print(
#     sd(tapply(stocks.panel.sub$HFL, 
#               as.character(stocks.panel.sub$symbol),
#               FUN=mean))  )
# }





# 4.10) Differences in Differences Analysis ------------------------------------

# 4.10a) Regulation NMS DID ----------------------------------------------------

# cut date range into PRE, PILOT and POST periods
date.cut <- as.factor(apply(stocks.NMS.df[range.idx,], 1, sum, na.rm=T))
levels(date.cut)[(levels(date.cut)==0)] <- "PRE"
levels(date.cut)[(levels(date.cut)==96)] <- "PILOT"
levels(date.cut)[(levels(date.cut)==1471)] <- "POST"
date.cut
NMS.fac <- date.cut[stocks.panel.pdf$date]

# segregate stocks taking part in pilots
stocks.pilot <- unique(stocks.panel.pdf$symbol[which(interaction(NMS.fac, stocks.panel.pdf$NMS)=="PILOT.TRUE")])
stocks.other <- unique(stocks.panel.pdf$symbol[which(interaction(NMS.fac, stocks.panel.pdf$NMS)=="PILOT.FALSE")])
PILOT.fac <- stocks.panel.pdf$symbol[] %in% stocks.pilot

summary(interaction(PILOT.fac, classes.size3))/114

# calculate DID metrics:
# Pilot stocks vs. non pilot stocks from Pilot to Pre periods
# Non pilot stocks vs. Pilot stocks from Post to Pilot periods
means.groups <- tapply(sqrt(stocks.panel.pdf$HFLV), 
                       interaction(NMS.fac, PILOT.fac),
                       FUN=mean)
means.groups <- tapply(sqrt(stocks.panel.pdf$EEU[classes.size3=="H"]), 
                       interaction(NMS.fac, PILOT.fac)[classes.size3=="H"],
                FUN=mean)
sds.groups <- tapply(sqrt(stocks.panel.pdf$EEU[classes.size3=="H"]), 
                       interaction(NMS.fac, PILOT.fac)[classes.size3=="H"],
                       FUN=sd)
Ns.groups <- tapply(sqrt(stocks.panel.pdf$EEU[classes.size3=="H"]), 
                     interaction(NMS.fac, PILOT.fac)[classes.size3=="H"],
                     FUN=length)
diff.F <- means.groups["PILOT.FALSE"] - means.groups["PRE.FALSE"]

diff.T <- means.groups["PILOT.TRUE"] - means.groups["PRE.TRUE"]
diff.in.diff.PILOT <- diff.T - diff.F
diff.in.diff.PILOT

diff.F.psd <- sqrt( (((sds.groups["PILOT.FALSE"]^2) * Ns.groups["PILOT.FALSE"]) + 
                       ((sds.groups["PRE.FALSE"]^2) * Ns.groups["PRE.FALSE"]) ) / 
                      (Ns.groups["PILOT.FALSE"] + Ns.groups["PRE.FALSE"]))
diff.T.psd <- sqrt( (((sds.groups["PILOT.TRUE"]^2) * Ns.groups["PILOT.TRUE"]) + 
                       ((sds.groups["PRE.TRUE"]^2) * Ns.groups["PRE.TRUE"]) ) / 
                      (Ns.groups["PILOT.TRUE"] + Ns.groups["PRE.TRUE"]))
diff.in.diff.PILOT/(diff.F.psd/sqrt(1197))


diff.F <- means.groups["POST.FALSE"] - means.groups["PILOT.FALSE"]
diff.T <- means.groups["POST.TRUE"] - means.groups["PILOT.TRUE"]
diff.in.diff.POST <- diff.F - diff.T
diff.in.diff.POST


# 4.10b) NAB DID ----------------------------------------------------


# 4.11) HFT Orders of Magnitude Changes

test.vec <- stocks.HFTflags.df[,3]
test.vec <- log(test.vec+1)
plot(test.vec-MovingAvg(test.vec, 60))
plot(Winsor(exp(test.vec-MovingAvg(test.vec, 20)),.01))

test.vec <- (1000000*stocks.hft.max.l15/stocks.vol.max.l15)[,3]
test.vec <- log(test.vec+1)
plot(test.vec-MovingAvg(test.vec, 60))
plot(Winsor(exp(test.vec-MovingAvg(test.vec, 20)),.001))


plot(log(test.vec+0.1))



# 5. EVENT EXAMPLES -------------------------------------------------

for (e in which(events.master.dn.df$PREW60.rel.r < -8 & 
                  events.master.dn.df$PREW30.HFT.f.rate > 0.5)) {
  PlotEventFull(events.master.dn.df, e)
}

for (e in which(events.master.up.df$PREW60.rel.r > 8 & 
                  events.master.up.df$PREW30.HFT.f.rate > 0.5)) {
  PlotEventFull(events.master.up.df, e)
}
